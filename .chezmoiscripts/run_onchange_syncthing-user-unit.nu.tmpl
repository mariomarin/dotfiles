#!/usr/bin/env nu
# Setup syncthing systemd user service
# Only runs on Linux (NixOS)

# From: https://nixos.org/manual/nixos/stable/index.html#sect-nixos-systemd-nixos
# User systemd services on the other hand, should be treated differently.
# Given a package that has a systemd unit file at #pkg-out#/lib/systemd/user/,
# using systemd.packages will make you able to start the service via
# systemctl --user start, but it won't start automatically on login.

{{- if eq .chezmoi.os "linux" }}

{{ $serviceName := "syncthing.service" -}}
{{ $runDir := "/run/current-system/sw/lib/systemd/user" -}}
{{ $runFile := joinPath $runDir $serviceName -}}
{{ $serviceDir := joinPath .chezmoi.homeDir ".config/systemd/user" -}}
{{ $serviceFile := joinPath $serviceDir $serviceName -}}
{{ $targetDir := joinPath .chezmoi.homeDir ".config/systemd/user/default.target.wants" -}}

# Check if the service file exists in the system
{{ if not (stat $runFile) }}
print "Warning: Syncthing systemd unit not found at {{ $runFile }}"
print "Make sure syncthing is installed in your NixOS system configuration"
exit 0
{{ end }}

# Resolve the symlink to get the actual Nix store path
let resolved_path = (readlink -f {{ $runFile | quote }} | str trim)
if ($resolved_path | is-empty) or not ({{ $runFile | quote }} | path exists) {
    print "Error: Could not resolve {{ $runFile }} to a valid file"
    exit 1
}

# Function to setup the symlink and enable service
def setup_syncthing_service [message: string] {
    print $message
    print $"Linking to: ($resolved_path)"
    mkdir {{ $serviceDir | quote }}
    mkdir {{ $targetDir | quote }}
    rm -f {{ $serviceFile | quote }}
    ln -sf $resolved_path {{ $serviceFile | quote }}
    systemctl --user daemon-reload
    systemctl --user enable {{ $serviceName }}
}

# Check if we need to create the symlink
{{ if or (not (stat $serviceFile)) (ne (lstat $serviceFile).type "symlink") }}
setup_syncthing_service "Creating/fixing syncthing systemd user service symlink..."
exit 0
{{ end }}

# Check if the symlink target has changed (e.g., Nix store path updated)
let current_target = try {
    readlink {{ $serviceFile | quote }} | str trim
} catch {
    ""
}

if $current_target != $resolved_path {
    setup_syncthing_service "Updating syncthing systemd user service symlink (Nix store path changed)..."
}

{{- end }}
