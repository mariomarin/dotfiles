#!/usr/bin/env nu
# Install packages from .chezmoidata/packages.yaml
# This script runs when the package list or script content changes
# Uses Nushell for cross-platform compatibility

let os = "{{ .chezmoi.os }}"

print $"ğŸ“¦ Installing packages for ($os)..."

match $os {
    "darwin" => {
        # macOS - use homebrew
        if (which brew | is-empty) {
            print "âŒ Homebrew not found. Please install: https://brew.sh"
            exit 1
        }

        # Install brews
        {{- range .packages.darwin.brews }}
        if (brew list {{ . }} | complete | get exit_code) != 0 {
            print $"  Installing {{ . }}..."
            brew install {{ . }}
        } else {
            print "  âœ“ {{ . }} already installed"
        }
        {{- end }}

        # Install casks
        {{- range .packages.darwin.casks }}
        if (brew list --cask {{ . }} | complete | get exit_code) != 0 {
            print $"  Installing {{ . }} (cask)..."
            brew install --cask {{ . }}
        } else {
            print "  âœ“ {{ . }} already installed"
        }
        {{- end }}
    }

    "windows" => {
        # Windows - use winget
        if (which winget | is-empty) {
            print "âŒ winget not found. Please install App Installer from Microsoft Store."
            exit 1
        }

        # Install winget packages
        {{- range .packages.windows.winget }}
        print $"  Checking {{ . }}..."
        let installed = (winget list --id "{{ . }}" --exact | complete)
        if ($installed.stdout | str contains "{{ . }}") {
            print "  âœ“ {{ . }} already installed"
        } else {
            print $"  Installing {{ . }}..."
            winget install --id "{{ . }}" --exact --silent --accept-package-agreements --accept-source-agreements
        }
        {{- end }}
    }

    "linux" => {
        # NixOS - packages managed via system configuration
        print "â­ï¸  Skipping: NixOS packages managed via system configuration"
    }

    _ => {
        print $"âŒ Unsupported OS: ($os)"
        exit 1
    }
}

print "âœ… Packages installed successfully"
