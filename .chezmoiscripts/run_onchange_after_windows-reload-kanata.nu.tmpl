{{- if eq .chezmoi.os "windows" -}}
#!/usr/bin/env nu
# Reload kanata when config changes (Windows)
# windows.kbd hash: {{ include "private_dot_config/kanata/windows.kbd" | sha256sum }}

def kanata-running [] {
    (do { tasklist | find "kanata" } | complete).exit_code == 0
}

def task-exists [] {
    (do { schtasks /Query /TN "Kanata" } | complete).exit_code == 0
}

def stop-kanata [] {
    print "Stopping kanata..."
    taskkill /IM kanata.exe /F | ignore
    sleep 1sec
}

def start-via-task [] {
    print "Starting kanata via scheduled task..."
    schtasks /Run /TN "Kanata"
}

def start-directly [] {
    let kanata_path = ($env.LOCALAPPDATA | path join "kanata" "kanata.exe")
    let config_path = ($env.USERPROFILE | path join ".config" "kanata" "windows.kbd")
    if not ($kanata_path | path exists) {
        print $"Kanata not found at ($kanata_path)"
        return
    }
    print "Starting kanata directly..."
    conhost --headless $kanata_path --cfg $config_path
}

# Early exit if not running
if not (kanata-running) {
    print "Kanata not running, skipping"
    exit 0
}

stop-kanata

if (task-exists) {
    start-via-task
} else {
    start-directly
}

print "âœ“ Kanata reloaded"
{{- end }}
