{{- if eq .chezmoi.os "windows" -}}
#!/usr/bin/env nu
# Reload kanata when config changes (Windows)
# windows.kbd hash: {{ include "private_dot_config/kanata/windows.kbd" | sha256sum }}

print "Reloading kanata (Windows)..."

# Check if kanata is running
let kanata_running = (do { tasklist | find "kanata" } | complete).exit_code == 0

if $kanata_running {
    print "Stopping kanata..."
    taskkill /IM kanata.exe /F | ignore
    sleep 1sec

    # Try to restart via scheduled task first (preferred method)
    let task_exists = (do { schtasks /Query /TN "Kanata" } | complete).exit_code == 0
    if $task_exists {
        print "Starting kanata via scheduled task..."
        schtasks /Run /TN "Kanata"
        print "Kanata reloaded"
    } else {
        # Fallback: start directly with conhost --headless
        let kanata_path = ($env.LOCALAPPDATA | path join "kanata" "kanata.exe")
        let config_path = ($env.USERPROFILE | path join ".config" "kanata" "windows.kbd")
        if ($kanata_path | path exists) {
            print "Starting kanata directly..."
            conhost --headless $kanata_path --cfg $config_path
            print "Kanata reloaded"
        } else {
            print "Kanata executable not found at ($kanata_path), skipping"
        }
    }
} else {
    print "Kanata not running, skipping"
}
{{- end }}
