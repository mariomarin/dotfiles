#!/usr/bin/env nu
# Setup systemd user services with Nix store symlink management (Linux/NixOS)
#
# This script manages user systemd service symlinks that need to track NixOS
# package updates (new Nix store paths). It handles multiple services in one place.

{{ $serviceDir := joinPath .chezmoi.homeDir ".config/systemd/user" -}}
{{ $targetDir := joinPath .chezmoi.homeDir ".config/systemd/user/default.target.wants" -}}

# Create directories if they don't exist
mkdir {{ $serviceDir | quote }}
mkdir {{ $targetDir | quote }}

# Function to setup a systemd user service symlink
def setup_service_symlink [
    service_name: string,
    source_path: string,
    --conditional = false,
    --condition-message = ""
] {
    # Skip if conditional and condition not met
    if $conditional {
        if $condition_message != "" {
            print $"Skipping ($service_name): ($condition_message)"
        }
        return
    }

    # Check if source exists
    if not ($source_path | path exists) {
        print $"Warning: ($service_name) unit not found at ($source_path)"
        return
    }

    # Resolve to actual Nix store path
    let resolved_path = try {
        readlink -f $source_path | str trim
    } catch {
        ""
    }

    if ($resolved_path | is-empty) or not ($resolved_path | path exists) {
        print $"Error: Could not resolve ($source_path) to a valid file"
        return
    }

    let service_file = {{ $serviceDir | quote }} ++ "/" ++ $service_name
    let current_target = try {
        readlink $service_file | str trim
    } catch {
        ""
    }

    # Check if symlink needs creating or updating
    if not ($service_file | path exists) {
        print $"Creating ($service_name) symlink â†’ ($resolved_path)"
        ln -sf $resolved_path $service_file
        systemctl --user daemon-reload
        systemctl --user enable $service_name

        # Start if not active
        let is_active = (systemctl --user is-active $service_name | str trim)
        if $is_active != "active" {
            print $"Starting ($service_name)..."
            systemctl --user start $service_name
        }
    } else if $current_target != $resolved_path {
        print $"Updating ($service_name) symlink (Nix store path changed)"
        print $"  Old: ($current_target)"
        print $"  New: ($resolved_path)"
        ln -sf $resolved_path $service_file
        systemctl --user daemon-reload
    }
}

# Syncthing service (all machines)
setup_service_symlink "syncthing.service" "/run/current-system/sw/lib/systemd/user/syncthing.service"

# SSH agent service (headless machines only - desktop uses GNOME Keyring)
{{ if not (.machineConfig.features.desktop | default false) -}}
setup_service_symlink "ssh-agent.service" "/etc/systemd/user/ssh-agent.service"
{{ else -}}
setup_service_symlink "ssh-agent.service" "/etc/systemd/user/ssh-agent.service" --conditional true --condition-message "Desktop machine (using GNOME Keyring)"
{{ end -}}

print "Systemd user services configured"
