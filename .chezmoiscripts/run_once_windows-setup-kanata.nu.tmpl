{{- if eq .chezmoi.os "windows" -}}
#!/usr/bin/env nu
# Setup kanata scheduled task (Windows, no admin required)

let task_name = "Kanata"
let kanata_path = ($env.LOCALAPPDATA | path join "kanata" "kanata.exe")
let config_path = ($env.USERPROFILE | path join ".config" "kanata" "windows.kbd")

# Check if kanata executable exists
if not ($kanata_path | path exists) {
    print $"⚠️  Kanata not found at ($kanata_path)"
    print "Download from: https://github.com/jtroo/kanata/releases"
    print $"Place kanata.exe in: ($env.LOCALAPPDATA | path join 'kanata')"
    exit 0
}

# Check if task already exists
let task_exists = (do { schtasks /Query /TN $task_name } | complete).exit_code == 0

if $task_exists {
    print $"✅ Scheduled task '($task_name)' already exists"
} else {
    print $"Creating scheduled task '($task_name)'..."

    # Create task to run at logon, limited privileges (no admin)
    # Using conhost --headless to run without visible window
    let command = $"conhost --headless ($kanata_path) --cfg ($config_path)"

    let result = (do {
        schtasks /Create /TN $task_name /TR $command /SC ONLOGON /RL LIMITED /F
    } | complete)

    if $result.exit_code == 0 {
        print $"✅ Scheduled task '($task_name)' created"
        print "Kanata will start automatically at logon"

        # Start it now
        print "Starting kanata..."
        schtasks /Run /TN $task_name
    } else {
        print $"❌ Failed to create scheduled task: ($result.stderr)"
    }
}
{{- end }}
