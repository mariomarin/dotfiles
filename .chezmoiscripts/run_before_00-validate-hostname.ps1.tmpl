#!/usr/bin/env pwsh
# Validate HOSTNAME environment variable
# This runs BEFORE any files are applied

$ErrorActionPreference = "Stop"

# Check if HOSTNAME is set
if (-not $env:HOSTNAME) {
    Write-Host "❌ HOSTNAME environment variable not set" -ForegroundColor Red
    Write-Host ""
    Write-Host "Set it before running chezmoi:" -ForegroundColor Yellow
    Write-Host '  $env:HOSTNAME = "prion"  # Choose from available machines below' -ForegroundColor Gray
    Write-Host ""
    Write-Host "Available machines:" -ForegroundColor Yellow

    # Try to list machines using yq if available
    $machinesFile = "{{ .chezmoi.sourceDir }}/.chezmoidata/machines.yaml"
    if (Get-Command yq -ErrorAction SilentlyContinue) {
        try {
            yq '.machines | keys | .[]' $machinesFile
        }
        catch {
            Write-Host "  (error reading machines.yaml)" -ForegroundColor Gray
        }
    }
    else {
        Write-Host "  (install yq to see list - run bootstrap script)" -ForegroundColor Gray
    }

    Write-Host ""
    exit 1
}

# Check if hostname exists in machines.yaml
if (Get-Command yq -ErrorAction SilentlyContinue) {
    $machinesFile = "{{ .chezmoi.sourceDir }}/.chezmoidata/machines.yaml"
    try {
        $result = yq -e ".machines.`"$env:HOSTNAME`"" $machinesFile 2>&1
        if ($LASTEXITCODE -ne 0) {
            Write-Host "⚠️  Warning: HOSTNAME '$env:HOSTNAME' not found in machines.yaml" -ForegroundColor Yellow
            Write-Host ""
            Write-Host "Available machines:" -ForegroundColor Yellow
            yq '.machines | keys | .[]' $machinesFile
            Write-Host ""
            Write-Host "Continuing with default configuration..." -ForegroundColor Yellow
            Write-Host ""
        }
        else {
            Write-Host "✅ Using machine configuration: $env:HOSTNAME" -ForegroundColor Green
        }
    }
    catch {
        # yq not working properly, skip validation
        Write-Host "✅ Using HOSTNAME: $env:HOSTNAME (yq validation skipped)" -ForegroundColor Green
    }
}
else {
    Write-Host "✅ Using HOSTNAME: $env:HOSTNAME (install yq for validation)" -ForegroundColor Green
}
