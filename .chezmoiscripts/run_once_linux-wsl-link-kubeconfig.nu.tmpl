#!/usr/bin/env nu
# Link WSL kubeconfig to Windows kubeconfig for seamless kubectl usage

{{- if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "nixos-wsl") }}

print "üîó Setting up shared kubeconfig between WSL and Windows..."

# Get Windows username from path
let win_user = (cmd.exe /c "echo %USERNAME%" | str trim)

if ($win_user | is-empty) {
    print "‚ùå Could not determine Windows username"
    exit 1
}

# Windows kubeconfig path (accessible from WSL)
let win_kube_dir = $"/mnt/c/Users/($win_user)/.kube"
let win_kube_config = $"($win_kube_dir)/config"

# WSL kubeconfig path
let wsl_kube_dir = $"($env.HOME)/.kube"
let wsl_kube_config = $"($wsl_kube_dir)/config"

# Create WSL .kube directory if it doesn't exist
mkdir $wsl_kube_dir

# Remove existing config if it's not a symlink
if ($wsl_kube_config | path exists) and (not ($wsl_kube_config | path type) == "symlink") {
    print $"‚ö†Ô∏è  Backing up existing kubeconfig to ($wsl_kube_config).backup"
    mv $wsl_kube_config $"($wsl_kube_config).backup"
}

# Create symlink if Windows kubeconfig exists
if ($win_kube_config | path exists) {
    ln -sf $win_kube_config $wsl_kube_config
    print $"‚úÖ Linked ($wsl_kube_config) ‚Üí ($win_kube_config)"
} else {
    print $"‚ÑπÔ∏è  Windows kubeconfig not found at ($win_kube_config)"
    print "   Configure kubectl on Windows first, then run 'chezmoi apply' again"
}

{{- end }}
