#!/usr/bin/env bash
# Link WSL kubeconfig to Windows kubeconfig for seamless kubectl usage

set -euo pipefail

{{- if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "nixos-wsl") }}

echo "üîó Setting up shared kubeconfig between WSL and Windows..."

# Get Windows username from path
WIN_USER=$(cmd.exe /c "echo %USERNAME%" 2>/dev/null | tr -d '\r')

if [ -z "$WIN_USER" ]; then
    echo "‚ùå Could not determine Windows username"
    exit 1
fi

# Windows kubeconfig path (accessible from WSL)
WIN_KUBE_DIR="/mnt/c/Users/$WIN_USER/.kube"
WIN_KUBE_CONFIG="$WIN_KUBE_DIR/config"

# WSL kubeconfig path
WSL_KUBE_DIR="$HOME/.kube"
WSL_KUBE_CONFIG="$WSL_KUBE_DIR/config"

# Create WSL .kube directory if it doesn't exist
mkdir -p "$WSL_KUBE_DIR"

# Remove existing config if it's not a symlink
if [ -f "$WSL_KUBE_CONFIG" ] && [ ! -L "$WSL_KUBE_CONFIG" ]; then
    echo "‚ö†Ô∏è  Backing up existing kubeconfig to $WSL_KUBE_CONFIG.backup"
    mv "$WSL_KUBE_CONFIG" "$WSL_KUBE_CONFIG.backup"
fi

# Create symlink if Windows kubeconfig exists
if [ -f "$WIN_KUBE_CONFIG" ]; then
    ln -sf "$WIN_KUBE_CONFIG" "$WSL_KUBE_CONFIG"
    echo "‚úÖ Linked $WSL_KUBE_CONFIG ‚Üí $WIN_KUBE_CONFIG"
else
    echo "‚ÑπÔ∏è  Windows kubeconfig not found at $WIN_KUBE_CONFIG"
    echo "   Configure kubectl on Windows first, then run 'chezmoi apply' again"
fi

{{- end }}
