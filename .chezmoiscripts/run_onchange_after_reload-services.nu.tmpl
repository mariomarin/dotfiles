#!/usr/bin/env nu
# Unified service reload script
# Only reloads services whose config files actually changed
#
# Script hash: {{ include ".scripts/reload-services.nu" | sha256sum }}
# Config checksums (triggers chezmoi onchange):
{{- if eq .chezmoi.os "darwin" }}
{{- range .services.darwin }}
{{- range .configs }}
# {{ . }}: {{ include . | sha256sum }}
{{- end }}
{{- end }}
{{- else if eq .chezmoi.os "linux" }}
{{- range .services.linux }}
{{- range .configs }}
# {{ . }}: {{ include . | sha256sum }}
{{- end }}
{{- end }}
{{- else if eq .chezmoi.os "windows" }}
{{- range .services.windows }}
{{- range .configs }}
# {{ . }}: {{ include . | sha256sum }}
{{- end }}
{{- end }}
{{ end }}
{{- /* Helper to combine hashes from multiple configs */ -}}
{{- define "combineHashes" -}}
{{- $combined := "" -}}
{{- range . -}}
{{- $combined = printf "%s%s" $combined (include . | sha256sum) -}}
{{- end -}}
{{- $combined | sha256sum -}}
{{- end }}

let services = '
{{- if eq .chezmoi.os "darwin" -}}
[
{{- range $i, $svc := .services.darwin }}
{{- if $i }},{{ end }}
  {"name":"{{ $svc.name }}","hash":"{{ template "combineHashes" $svc.configs }}","type":"{{ $svc.type }}"
{{- if eq $svc.type "launchctl" }},"service":"{{ $svc.service }}"{{ end }}
{{- if eq $svc.type "command" }},"check":"{{ $svc.check }}","reload":"{{ $svc.reload }}"{{ end -}}
  }
{{- end }}
]
{{- else if eq .chezmoi.os "linux" -}}
[
{{- range $i, $svc := .services.linux }}
{{- if $i }},{{ end }}
  {"name":"{{ $svc.name }}","hash":"{{ template "combineHashes" $svc.configs }}","type":"{{ $svc.type }}"
{{- if eq $svc.type "systemctl" }},"service":"{{ $svc.service }}"{{ end -}}
  }
{{- end }}
]
{{- else if eq .chezmoi.os "windows" -}}
[
{{- range $i, $svc := .services.windows }}
{{- if $i }},{{ end }}
  {"name":"{{ $svc.name }}","hash":"{{ template "combineHashes" $svc.configs }}","type":"{{ $svc.type }}"
{{- if eq $svc.type "windows-task" }},"task":"{{ $svc.task }}","exe":"{{ $svc.exe }}"{{ end -}}
  }
{{- end }}
]
{{- end }}'

nu "{{ .chezmoi.sourceDir }}/.scripts/reload-services.nu" --services $services
