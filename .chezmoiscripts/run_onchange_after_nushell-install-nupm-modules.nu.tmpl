#!/usr/bin/env nu
# Install all nupm modules
# Triggers when any module's nupm.nuon changes
# bitwarden hash: {{ include "private_dot_config/nushell/modules/bitwarden/nupm.nuon" | sha256sum }}
# claude-helpers hash: {{ include "private_dot_config/nushell/modules/claude-helpers/nupm.nuon" | sha256sum }}
# sesh hash: {{ include "private_dot_config/nushell/modules/sesh/nupm.nuon" | sha256sum }}

let modules_dir = ($nu.home-path | path join '.config' 'nushell' 'modules')
let nupm_path = ($nu.home-path | path join '.local' 'share' 'nupm' 'nupm')

# Check if nupm is installed
if not ($nupm_path | path exists) {
    print "‚ö†Ô∏è  nupm not found. Skipping module installation."
    exit 0
}

print "üì¶ Installing Nushell packages via nupm..."

# Install from nupm registry
print "  Installing nu-scripts (git, docker, kubernetes utilities)..."
let result = do { ^nu -c $"use ($nupm_path); nupm install nu-scripts" } | complete
if $result.exit_code == 0 {
    print "  ‚úì nu-scripts installed"
} else {
    print "  ‚ö†Ô∏è  Failed to install nu-scripts from registry"
}

# Install local custom modules
let local_modules = [
    "bitwarden"
    "claude-helpers"
    "sesh"
]

for module in $local_modules {
    let module_path = ($modules_dir | path join $module)

    if not ($module_path | path exists) {
        print $"  ‚ö†Ô∏è  Module not found: ($module_path)"
        continue
    }

    print $"  Installing ($module)..."
    let result = do { ^nu -c $"use ($nupm_path); nupm install --path ($module_path) --force" } | complete
    if $result.exit_code == 0 {
        print $"  ‚úì ($module) installed"
    } else {
        print $"  ‚ö†Ô∏è  Failed to install ($module)"
    }
}

print ""
print "‚úÖ All modules installed successfully"
print "   Modules are now available for use with: use <module-name>"
