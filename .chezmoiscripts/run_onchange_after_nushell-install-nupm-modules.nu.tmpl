#!/usr/bin/env nu
# Install all nupm modules from ~/.config/nushell/modules
# This script runs when this file changes

{{- if eq .chezmoi.os "windows" }}
let modules_dir = ($env.USERPROFILE | path join '.config' 'nushell' 'modules')
let nupm_path = ($env.USERPROFILE | path join '.local' 'share' 'nupm' 'nupm')
{{- else }}
let modules_dir = ($env.HOME | path join '.config' 'nushell' 'modules')
let nupm_path = ($env.HOME | path join '.local' 'share' 'nupm' 'nupm')
{{- end }}

# Check if nupm is installed
if not ($nupm_path | path exists) {
    print "‚ö†Ô∏è  nupm not found. Please run the nupm install script first."
    exit 1
}

print "üì¶ Installing Nushell modules via nupm..."

# List of modules to install
let modules = [
    "bitwarden"
    "claude-helpers"
    "sesh"
    "container-use-completions"
    "aws-sso-cli-completions"
    "git-branchless-completions"
]

# Install each module
for module in $modules {
    let module_path = ($modules_dir | path join $module)

    if ($module_path | path exists) {
        print $"  Installing ($module)..."
        try {
            ^nu -c $"use ($nupm_path); nupm install --path ($module_path) --force"
            print $"  ‚úì ($module) installed"
        } catch {
            print $"  ‚ö†Ô∏è  Failed to install ($module)"
        }
    } else {
        print $"  ‚ö†Ô∏è  Module not found: ($module_path)"
    }
}

print ""
print "‚úÖ All modules installed successfully"
print "   Modules are now available for use with: use <module-name>"
