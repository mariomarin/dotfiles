#!/bin/bash
# Smart plugin updater - only updates if needed
# This script has a .tmpl extension so chezmoi will process it
# and it will only run when the hash changes

# Hash: {{ include ".chezmoidata/plugin-updates.toml" | sha256sum }}

set -euo pipefail

LAST_UPDATE_FILE="$HOME/.local/state/last-plugin-update"
UPDATE_FREQUENCY_DAYS="{{ .updates.update_frequency | default 7 }}"
AUTO_UPDATE="{{ .updates.auto_update | default true }}"

# Skip if auto-update is disabled
if [[ "$AUTO_UPDATE" != "true" ]]; then
    exit 0
fi

# Create state directory if it doesn't exist
mkdir -p "$(dirname "$LAST_UPDATE_FILE")"

# Check if we should update based on frequency
should_update() {
    if [[ ! -f "$LAST_UPDATE_FILE" ]]; then
        return 0  # No last update file, should update
    fi
    
    last_update=$(stat -c %Y "$LAST_UPDATE_FILE" 2>/dev/null || echo 0)
    current_time=$(date +%s)
    days_since_update=$(( (current_time - last_update) / 86400 ))
    
    if [[ $days_since_update -ge $UPDATE_FREQUENCY_DAYS ]]; then
        return 0  # Time to update
    else
        echo "â„¹ï¸  Skipping plugin updates (last update was $days_since_update days ago)"
        return 1  # Too soon
    fi
}

if should_update; then
    echo "ðŸ”„ Running scheduled plugin updates..."
    
    # Update Neovim plugins
    {{ if .neovim.enabled -}}
    if command -v nvim &>/dev/null; then
        echo "ðŸ“¦ Updating Neovim plugins..."
        nvim --headless "+Lazy! sync" +qa 2>/dev/null || true
    fi
    {{- end }}
    
    # Update Tmux plugins (only if not managed by chezmoiexternal)
    {{ if .tmux.enabled -}}
    if [[ -d "$HOME/.local/share/tmux/plugins/tpm" ]]; then
        echo "ðŸ“¦ Checking Tmux plugins..."
        # Only update if not managed by .chezmoiexternal.toml
        if [[ ! -f "$HOME/.local/share/tmux/plugins/.chezmoiexternal.toml" ]]; then
            "$HOME/.local/share/tmux/plugins/tpm/bin/update_plugins" all 2>/dev/null || true
        else
            echo "  Tmux plugins managed by chezmoi external"
        fi
    fi
    {{- end }}
    
    # Update Zim modules
    {{ if .zim.enabled -}}
    if command -v zimfw &>/dev/null; then
        echo "ðŸ“¦ Updating Zim modules..."
        zimfw update 2>/dev/null || true
    fi
    {{- end }}
    
    # Update timestamp
    touch "$LAST_UPDATE_FILE"
    echo "âœ… Plugin updates complete"
fi