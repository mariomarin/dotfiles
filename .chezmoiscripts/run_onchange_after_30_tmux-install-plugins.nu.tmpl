#!/usr/bin/env nu
# Install TPM plugins when plugins.tmux changes
# plugins.tmux hash: {{ include "private_dot_config/tmux/plugins.tmux" | sha256sum }}

let home = ($env.HOME? | default $env.USERPROFILE?)
let plugin_path = ($home | path join '.local' 'share' 'tmux' 'plugins')
let tpm_dir = ($plugin_path | path join 'tpm')
let install_script = ($tpm_dir | path join 'bin' 'install_plugins')

# Skip if tmux not installed yet
if (which tmux | is-empty) {
    print "tmux not installed yet, skipping plugin installation"
    exit 0
}

# Skip if TPM not installed yet
if not ($install_script | path exists) {
    print "TPM not installed yet, skipping plugin installation"
    exit 0
}

print "Installing tmux plugins via TPM..."
let result = with-env { TMUX_PLUGIN_MANAGER_PATH: $plugin_path } {
    do { ^$install_script } | complete
}

if $result.exit_code != 0 {
    # TPM install can fail if tmux server isn't running - that's OK
    let is_expected_error = (($result.stderr | str contains "Tmux Plugin Manager not configured") or ($result.stderr | str contains "Unknown variable"))
    if $is_expected_error {
        print "TPM install skipped (tmux server not running or not configured)"
        print "Plugins will be installed on first tmux start with prefix+I"
        exit 0
    }
    print $result.stderr
    exit $result.exit_code
}

print $result.stdout
