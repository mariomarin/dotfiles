#!/usr/bin/env nu
# Install Bitbucket CLI from pre-built binary
# This script runs when bitbucketCli version in .chezmoidata.toml changes

let version = "{{ .versions.bitbucketCli }}"
let arch = (uname | get machine)
let os = "windows"

# Map architecture names
let go_arch = if $arch == "x86_64" {
    "amd64"
} else if $arch == "aarch64" {
    "arm64"
} else {
    print $"❌ Unsupported architecture: ($arch)"
    exit 1
}

let binary_name = $"bb_($version)_($os)_($go_arch).zip"
let download_url = $"https://github.com/gildas/bitbucket-cli/releases/download/($version)/($binary_name)"
let install_dir = $"($env.USERPROFILE)\\.local\\bin"

print $"Installing bitbucket-cli ($version) for ($os)/($go_arch)..."

# Create install directory if it doesn't exist
mkdir $install_dir

# Download and extract
print $"Downloading from ($download_url)..."
let temp_zip = $"($env.TEMP)\\bb.zip"
http get $download_url | save --force $temp_zip

print "Extracting archive..."
# Use PowerShell to extract zip on Windows
pwsh -Command $"Expand-Archive -Path '($temp_zip)' -DestinationPath '($env.TEMP)' -Force"

# Install binary
print $"Installing to ($install_dir)\\bb.exe..."
mv $"($env.TEMP)\\bb.exe" $"($install_dir)\\bb.exe"

# Cleanup
rm $temp_zip

# Verify installation
print "Verifying installation..."
with-env {PATH: ($env.PATH | prepend $install_dir)} {
    bb version
}

print "✅ bitbucket-cli installed successfully"
