# WSL NixOS Setup and Management
# This justfile helps Windows users set up and manage NixOS on WSL2

# Set default shell to nushell for cross-platform scripting
set shell := ["nu", "-c"]

# OS compatibility check - only run on Windows
_check-os:
    #!/usr/bin/env nu
    if (sys | get host.name) != "Windows" {
        print "‚ùå Error: WSL setup commands are only for Windows"
        print "   These commands help set up NixOS on WSL2 from Windows"
        exit 1
    }

# Default: show help
default:
    @just --list

# Check if WSL2 is installed
check-wsl: _check-os
    #!/usr/bin/env nu
    print "üîç Checking WSL2 installation..."
    let result = (do { wsl --version } | complete)
    if $result.exit_code != 0 {
        print "‚ùå WSL is not installed"
        print "   Run: just install-wsl"
        exit 1
    }
    print $result.stdout
    print "‚úÖ WSL2 is installed"

# Install WSL2 (requires Administrator privileges)
install-wsl: _check-os
    #!/usr/bin/env nu
    # Check if WSL is already installed
    let wsl_installed = (do { wsl --version } | complete | get exit_code) == 0
    if $wsl_installed {
        print "‚úÖ WSL2 is already installed"
        wsl --version
        exit 0
    }

    print "üì¶ Installing WSL2..."
    print "‚ö†Ô∏è  This requires Administrator privileges"
    print "   You may be prompted for elevation"
    print ""
    wsl --install
    print ""
    print "‚úÖ WSL2 installation started"
    print "üí° You may need to restart your computer"
    print "   After restart, run: just check-wsl"

# Download latest NixOS-WSL tarball
download-nixos: _check-os
    #!/usr/bin/env nu
    # Check if already downloaded
    if ("nixos-wsl.tar.gz" | path exists) {
        print "‚úÖ nixos-wsl.tar.gz already exists"
        print "üí° To re-download, delete the file first: rm nixos-wsl.tar.gz"
        exit 0
    }

    print "üì• Downloading latest NixOS-WSL..."

    # Fetch latest release info from GitHub
    let release_url = "https://api.github.com/repos/nix-community/NixOS-WSL/releases/latest"
    let release_info = (http get $release_url)
    let version = $release_info.tag_name
    let download_url = ($release_info.assets | where name =~ "nixos-wsl.tar.gz" | first | get browser_download_url)

    print $"üì¶ Latest version: ($version)"
    print $"üîó Download URL: ($download_url)"
    print ""

    # Download to current directory
    print "‚è¨ Downloading..."
    http get $download_url | save nixos-wsl.tar.gz

    print "‚úÖ Downloaded nixos-wsl.tar.gz"
    print $"üí° Next step: just import-nixos"

# Import NixOS into WSL
import-nixos: _check-os
    #!/usr/bin/env nu
    # Check if NixOS is already imported
    let nixos_exists = (wsl --list --quiet | lines | any {|line| $line =~ "NixOS" })
    if $nixos_exists {
        print "‚úÖ NixOS is already imported in WSL"
        print "üí° To reinstall, first run: just uninstall-nixos"
        exit 0
    }

    print "üì¶ Importing NixOS into WSL..."

    if not ("nixos-wsl.tar.gz" | path exists) {
        print "‚ùå nixos-wsl.tar.gz not found"
        print "   Run: just download-nixos"
        exit 1
    }

    let nixos_path = ($env.USERPROFILE | path join "NixOS")
    print $"üìÇ Installation path: ($nixos_path)"

    # Import NixOS distribution
    wsl --import NixOS $nixos_path nixos-wsl.tar.gz --version 2

    print "‚úÖ NixOS imported successfully"
    print "üí° Next steps:"
    print "   1. just start-nixos"
    print "   2. Inside WSL, set up dotfiles with chezmoi"

# Start NixOS WSL instance
start-nixos: _check-os
    #!/usr/bin/env nu
    print "üöÄ Starting NixOS WSL..."
    wsl -d NixOS

# List installed WSL distributions
list-distros: _check-os
    #!/usr/bin/env nu
    print "üìã Installed WSL distributions:"
    wsl --list --verbose

# Set NixOS as default WSL distribution
set-default: _check-os
    #!/usr/bin/env nu
    print "‚öôÔ∏è  Setting NixOS as default WSL distribution..."
    wsl --set-default NixOS
    print "‚úÖ NixOS is now the default WSL distribution"
    print "üí° You can now use 'wsl' to start NixOS directly"

# Stop NixOS WSL instance
stop-nixos: _check-os
    #!/usr/bin/env nu
    print "üõë Stopping NixOS WSL..."
    wsl --terminate NixOS
    print "‚úÖ NixOS WSL stopped"

# Unregister/remove NixOS from WSL
uninstall-nixos: _check-os
    #!/usr/bin/env nu
    print "‚ö†Ô∏è  WARNING: This will remove NixOS and all its data!"
    print "Press Ctrl+C to cancel, or Enter to continue..."
    input

    print "üóëÔ∏è  Unregistering NixOS from WSL..."
    wsl --unregister NixOS

    print "‚úÖ NixOS unregistered from WSL"
    print "üí° You can reinstall with: just import-nixos"

# Run a command in NixOS WSL
run COMMAND: _check-os
    #!/usr/bin/env nu
    wsl -d NixOS --exec {{COMMAND}}

# Open NixOS WSL in Windows Terminal
terminal: _check-os
    #!/usr/bin/env nu
    print "üñ•Ô∏è  Opening NixOS in Windows Terminal..."
    wt -w 0 new-tab -p "NixOS"

# Show WSL system information
info: _check-os
    #!/usr/bin/env nu
    print "‚ÑπÔ∏è  WSL System Information"
    print "========================="
    print ""
    wsl --status
    print ""
    print "NixOS Distribution Info:"
    wsl -d NixOS --exec cat /etc/os-release

# Health check for WSL setup
health: _check-os
    #!/usr/bin/env nu
    print "üè• WSL NixOS Health Check"
    print "========================="
    print ""

    # Check WSL
    print "WSL Installation:"
    let wsl_installed = (do { wsl --version } | complete | get exit_code) == 0
    if $wsl_installed {
        print "  ‚úÖ WSL2 installed"
    } else {
        print "  ‚ùå WSL2 not installed"
    }

    # Check if NixOS is imported
    print ""
    print "NixOS Distribution:"
    let nixos_exists = (wsl --list --quiet | lines | any {|line| $line =~ "NixOS" })
    if $nixos_exists {
        print "  ‚úÖ NixOS imported"

        # Check if running
        let nixos_running = (wsl --list --running | lines | any {|line| $line =~ "NixOS" })
        if $nixos_running {
            print "  ‚úÖ NixOS running"
        } else {
            print "  ‚ö†Ô∏è  NixOS not running (start with: just start-nixos)"
        }
    } else {
        print "  ‚ùå NixOS not imported (run: just import-nixos)"
    }

    print ""

# Complete WSL NixOS setup (one-command install)
setup: _check-os
    #!/usr/bin/env nu
    print "üöÄ Complete WSL NixOS Setup"
    print "==========================="
    print ""
    print "This will:"
    print "  1. Check/Install WSL2"
    print "  2. Download NixOS-WSL"
    print "  3. Import NixOS into WSL"
    print "  4. Set NixOS as default"
    print ""
    print "Press Ctrl+C to cancel, or Enter to continue..."
    input

    # Step 1: Check WSL
    print ""
    print "Step 1: Checking WSL2..."
    let wsl_installed = (do { wsl --version } | complete | get exit_code) == 0
    if not $wsl_installed {
        print "Installing WSL2..."
        just install-wsl
        print "‚ö†Ô∏è  Please restart your computer and run 'just setup' again"
        exit 0
    }
    print "‚úÖ WSL2 is installed"

    # Step 2: Download NixOS
    print ""
    print "Step 2: Downloading NixOS-WSL..."
    if not ("nixos-wsl.tar.gz" | path exists) {
        just download-nixos
    } else {
        print "‚úÖ nixos-wsl.tar.gz already downloaded"
    }

    # Step 3: Import NixOS
    print ""
    print "Step 3: Importing NixOS..."
    let nixos_exists = (wsl --list --quiet | lines | any {|line| $line =~ "NixOS" })
    if not $nixos_exists {
        just import-nixos
    } else {
        print "‚úÖ NixOS already imported"
    }

    # Step 4: Set as default
    print ""
    print "Step 4: Setting NixOS as default..."
    just set-default

    print ""
    print "‚ú® Setup complete!"
    print ""
    print "Next steps:"
    print "  1. Start NixOS: just start-nixos"
    print "  2. Inside WSL, install chezmoi: nix-shell -p chezmoi"
    print "  3. Apply dotfiles: chezmoi init --apply YOUR_USERNAME"
    print "  4. Build NixOS config: cd ~/.local/share/chezmoi && just nixos/switch"
