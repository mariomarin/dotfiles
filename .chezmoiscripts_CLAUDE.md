# CLAUDE.md - Chezmoi Scripts

This directory contains scripts that run during `chezmoi apply`.

## Script Types

### run_once_ Scripts

Execute only once. State tracked in chezmoi's database.

- Example: `run_once_install-tool.sh`

### run_onchange_ Scripts

Execute when script content changes.

- Example: `run_onchange_configure-service.sh.tmpl`

### run_after_ Scripts

Execute after all files are applied.

- Example: `run_after_reload-config.sh`

## Current Scripts

### run_onchange_syncthing-user-unit.sh.tmpl

- **Purpose**: Manage syncthing systemd user service
- **Pattern**: Create symlink to Nix store path
- **Features**: Auto-updates when package changes

### run_onchange_autostart-desktop-files.sh.tmpl

- **Purpose**: Manage desktop autostart entries
- **Pattern**: Link to system desktop files or create custom ones
- **Applications**: Firefox, Xfce Power Manager, KDE Connect, Alacritty+tmux

### run_onchange_enable-user-services.sh.tmpl

- **Purpose**: Enable systemd user services
- **Features**: Checks for service existence before enabling

### run_onchange_configure-nix-and-atuin.sh

- **Purpose**: Configure Nix and Atuin
- **Note**: Check if this is still needed with current setup

### run_onchange_sync-tmux-and-zimfw.sh

- **Purpose**: Sync tmux plugins and Zim modules
- **Note**: May be replaced by topgrade

## NixOS Integration Pattern

For Nix store packages:

```bash
# Resolve symlink to actual store path
resolved_path=$(readlink -f /run/current-system/sw/path/to/file)

# Create direct symlink to store path
ln -sf "$resolved_path" ~/.config/target/location
```

## Template Variables

Common chezmoi variables used:

- `{{ .chezmoi.homeDir }}` - User's home directory
- `{{ .chezmoi.os }}` - Operating system
- `{{ if stat "/path" }}` - Conditional execution

## Adding New Scripts

1. Choose appropriate prefix (run_once_, run_onchange_, run_after_)
2. Add `.tmpl` suffix if using templates
3. Make script idempotent
4. Use `set -euo pipefail` for safety
5. Add clear echo statements for user feedback

## Debugging Scripts

### Force Re-run

```bash
# Clear specific script state
chezmoi state delete --bucket=scriptState --key=script-name

# Clear all run_once_ scripts
chezmoi state delete-bucket --bucket=scriptState
```

### Test Script

```bash
chezmoi execute-template < script.tmpl | bash -x
```

## Best Practices

- Always check if files/commands exist before using
- Use absolute paths or chezmoi variables
- Provide user feedback with echo statements
- Handle errors gracefully
- Make scripts work on fresh systems
