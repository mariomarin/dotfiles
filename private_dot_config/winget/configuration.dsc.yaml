# yaml-language-server: $schema=https://aka.ms/configuration-dsc-schema/0.2
# Winget Configuration DSC for declarative package installation
# See: https://learn.microsoft.com/en-us/windows/package-manager/configuration/
properties:
  resources:
    # Fonts (Nerd Fonts for Unicode symbols ⎋ ⭾ ⇪ ⌫ etc. in kanata config, terminal)
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install JetBrains Mono Nerd Font
        allowPrerelease: true
      settings:
        id: DEVCOM.JetBrainsMonoNerdFont
        source: winget
    # Shell and terminal
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install Oh My Posh
        allowPrerelease: true
      settings:
        id: JanDeDobbeleer.OhMyPosh
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install Nushell
        allowPrerelease: true
      settings:
        id: Nushell.Nushell
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install Carapace
        allowPrerelease: true
      settings:
        id: rsteube.Carapace
        source: winget
    # nupm package manager for Nushell
    - resource: PSDscResources/Script
      directives:
        description: Install nupm package manager
        dependsOn:
          - Install Git
          - Install Nushell
      settings:
        GetScript: |
          $nupmPath = "$env:USERPROFILE\.local\share\nupm\nupm"
          @{ Result = if (Test-Path $nupmPath) { 'Present' } else { 'Absent' } }
        TestScript: |
          $nupmPath = "$env:USERPROFILE\.local\share\nupm\nupm"
          Test-Path $nupmPath
        SetScript: |
          $nupmDir = "$env:USERPROFILE\.local\share\nupm"
          if (-not (Test-Path $nupmDir)) {
            New-Item -ItemType Directory -Path $nupmDir -Force | Out-Null
          }
          # Use --quiet to suppress stderr progress (DSC treats stderr as failure)
          git clone --quiet https://github.com/nushell/nupm.git "$nupmDir\nupm"
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install Alacritty
        allowPrerelease: true
      settings:
        id: Alacritty.Alacritty
        source: winget
    # Editor
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install Neovim
        allowPrerelease: true
      settings:
        id: Neovim.Neovim
        source: winget
    # Version control
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install Git
        allowPrerelease: true
      settings:
        id: Git.Git
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install GitHub CLI
        allowPrerelease: true
      settings:
        id: GitHub.cli
        source: winget
    # Search and text processing
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install fzf
        allowPrerelease: true
      settings:
        id: junegunn.fzf
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install ripgrep
        allowPrerelease: true
      settings:
        id: BurntSushi.ripgrep.MSVC
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install fd
        allowPrerelease: true
      settings:
        id: sharkdp.fd
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install jq
        allowPrerelease: true
      settings:
        id: jqlang.jq
        source: winget
    # Modern CLI replacements
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install bat
        allowPrerelease: true
      settings:
        id: sharkdp.bat
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install eza
        allowPrerelease: true
      settings:
        id: eza-community.eza
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install delta
        allowPrerelease: true
      settings:
        id: dandavison.delta
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install zoxide
        allowPrerelease: true
      settings:
        id: ajeetdsouza.zoxide
        source: winget
    # Development tools
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install Just
        allowPrerelease: true
      settings:
        id: Casey.Just
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install direnv
        allowPrerelease: true
      settings:
        id: direnv.direnv
        source: winget
    # Kubernetes tools
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install kubectl
        allowPrerelease: true
      settings:
        id: Kubernetes.kubectl
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install kubelogin
        allowPrerelease: true
      settings:
        id: Microsoft.Azure.Kubelogin
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install krew
        allowPrerelease: true
      settings:
        id: Kubernetes.krew
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install kubectx
        allowPrerelease: true
      settings:
        id: ahmetb.kubectx
        source: winget
    # System utilities
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install topgrade
        allowPrerelease: true
      settings:
        id: topgrade-rs.topgrade
        source: winget
    # Keyboard remapping
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install Kanata
        allowPrerelease: true
      settings:
        id: jtroo.kanata_gui
        source: winget
    # Kanata scheduled task (run at startup)
    - resource: PSDscResources/Script
      directives:
        description: Create Kanata scheduled task
        dependsOn:
          - Install Kanata
      settings:
        GetScript: |
          $task = Get-ScheduledTask -TaskName 'Kanata' -ErrorAction SilentlyContinue
          @{ Result = if ($task) { 'Present' } else { 'Absent' } }
        TestScript: |
          $task = Get-ScheduledTask -TaskName 'Kanata' -ErrorAction SilentlyContinue
          return ($null -ne $task)
        SetScript: |
          $kanataCmd = Get-Command kanata -ErrorAction SilentlyContinue
          if (-not $kanataCmd) {
            Write-Warning "Kanata not found in PATH. Skipping task creation."
            return
          }
          $kanataPath = $kanataCmd.Source
          $configPath = "$env:USERPROFILE\.config\kanata\windows.kbd"
          if (-not (Test-Path $configPath)) {
            Write-Warning "Kanata config not found at: $configPath"
            return
          }
          $action = New-ScheduledTaskAction -Execute $kanataPath -Argument "--cfg `"$configPath`""
          $trigger = New-ScheduledTaskTrigger -AtLogOn
          $principal = New-ScheduledTaskPrincipal -UserId $env:USERNAME -LogonType Interactive -RunLevel Highest
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 1)
          Register-ScheduledTask -TaskName 'Kanata' -Action $action -Trigger $trigger -Principal $principal -Settings $settings -Description 'Kanata keyboard remapping service' -Force | Out-Null
    # GUI applications
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install Visual Studio Code
        allowPrerelease: true
      settings:
        id: Microsoft.VisualStudioCode
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install Kubernetes Lens
        allowPrerelease: true
      settings:
        id: Mirantis.Lens
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install Remote Desktop Manager
        allowPrerelease: true
      settings:
        id: Devolutions.RemoteDesktopManager
        source: winget
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install Azure CLI
        allowPrerelease: true
      settings:
        id: Microsoft.AzureCLI
        source: winget
    # PowerShell
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      directives:
        description: Install PowerShell
        allowPrerelease: true
      settings:
        id: Microsoft.PowerShell
        source: winget
    # Trust PSGallery before installing modules
    - resource: PSDscResources/Script
      directives:
        description: Trust PSGallery repository
      settings:
        GetScript: |
          @{ Result = (Get-PSRepository -Name PSGallery).InstallationPolicy }
        TestScript: |
          (Get-PSRepository -Name PSGallery).InstallationPolicy -eq 'Trusted'
        SetScript: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
    # PowerShell Gallery modules
    - resource: PSModule
      directives:
        description: Install PSReadLine
        dependsOn:
          - Trust PSGallery repository
      settings:
        Name: PSReadLine
        Repository: PSGallery
    - resource: PSModule
      directives:
        description: Install posh-git
      settings:
        Name: posh-git
        Repository: PSGallery
    - resource: PSModule
      directives:
        description: Install Terminal-Icons
      settings:
        Name: Terminal-Icons
        Repository: PSGallery
    - resource: PSModule
      directives:
        description: Install PSFzf
      settings:
        Name: PSFzf
        Repository: PSGallery
    - resource: PSModule
      directives:
        description: Install git-aliases
      settings:
        Name: git-aliases
        Repository: PSGallery
    - resource: PSModule
      directives:
        description: Install CompletionPredictor
      settings:
        Name: CompletionPredictor
        Repository: PSGallery
  configurationVersion: 0.2.0
