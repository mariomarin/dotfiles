# User configuration sourced by interactive shells

# Load atuin configuration (sets ATUIN_NOBIND) before zim modules initialize atuin
[[ -f "${XDG_CONFIG_HOME:-$HOME/.config}/zsh/atuin-config.zsh" ]] && \
  source "${XDG_CONFIG_HOME:-$HOME/.config}/zsh/atuin-config.zsh"

# Load zsh-vi-mode configuration if it exists
[[ -f "${XDG_CONFIG_HOME:-$HOME/.config}/zsh/zsh-vi-mode-config.zsh" ]] && \
  source "${XDG_CONFIG_HOME:-$HOME/.config}/zsh/zsh-vi-mode-config.zsh"

# aliases {{{

# vim
alias vi=nvim

# git
alias pr="git push-track && gh pr create --fill"
alias checks="gh pr checks"
alias merge="gh pr merge --delete-branch --merge && git pull"
alias approve="gh pr review --approve"

# chezmoi
alias ce="chezmoi edit --apply"

# kubernetes
alias k='kubectl'

# tmux-fingers (formerly thumbs)
# Note: tmux-fingers doesn't have a standalone CLI tool
# Use fzf or similar tools for picking outside of tmux

# xsel
alias xc='xsel --clipboard'
# }}} End aliases

# Temporary Files
if [[ ! -d "$TMPDIR" ]]; then
  export TMPDIR="/tmp/$USER"
  mkdir -p -m 700 "$TMPDIR"
fi

TMPPREFIX="${TMPDIR%/}/zsh"
if [[ ! -d "$TMPPREFIX" ]]; then
  mkdir -p "$TMPPREFIX"
fi

# node
npm config set prefix "$NPM_CONFIG_PREFIX"

# SSH agent configuration
if [[ -n "$DISPLAY" ]] || [[ -n "$WAYLAND_DISPLAY" ]]; then
  # Desktop: Use GNOME Keyring SSH agent
  # Primary: GNOME Control Center socket
  if [[ -S "/run/user/$(id -u)/gcr/ssh" ]]; then
    export SSH_AUTH_SOCK="/run/user/$(id -u)/gcr/ssh"
  # Alternative: GNOME Keyring socket location
  elif [[ -S "/run/user/$(id -u)/keyring/ssh" ]]; then
    export SSH_AUTH_SOCK="/run/user/$(id -u)/keyring/ssh"
  fi
else
  # Headless (WSL/VMs): Use systemd SSH agent
  if [[ -S "/run/user/$(id -u)/ssh-agent" ]]; then
    export SSH_AUTH_SOCK="/run/user/$(id -u)/ssh-agent"
  fi
fi

# Test SSH agent connection
if [[ -n "$SSH_AUTH_SOCK" ]] && command -v ssh-add >/dev/null 2>&1; then
  ssh-add -l >/dev/null 2>&1 || true
fi

# zoxide (fasd replacement)
eval "$(zoxide init zsh)"

# direnv
eval "$(direnv hook zsh)"

# Zsh configuration
# Start configuration added by Zim install {{{
# User configuration sourced by interactive shells

# Remove path separator from WORDCHARS.
WORDCHARS=${WORDCHARS//[\/]/}

# prefix for git zimfw module
zstyle ':zim:git' aliases-prefix 'g'

# Install missing modules and update ${ZIM_HOME}/init.zsh if missing or outdated.
if [[ ! ${ZIM_HOME}/init.zsh -nt ${ZIM_CONFIG_FILE:-${ZDOTDIR:-${HOME}}/.zimrc} ]]; then
  # Update static initialization script if it's outdated, before sourcing it
  source ${ZIM_HOME}/zimfw.zsh init -q
fi
source ${ZIM_HOME}/init.zsh

# End configuration added by Zim install }}}

# Unalias zimfw git module aliases that conflict with CLI tools
# The git module is configured to use prefix 'g' (set above)
# See ~/.config/zim/modules/git/init.zsh for full alias list
#
# Conflicts:
# - gh: git help (conflicts with GitHub CLI)
# - gt: git tag (conflicts with Graphite CLI)
unalias gh 2>/dev/null
unalias gt 2>/dev/null

# Post-init module configuration
# Note: Key bindings that might be overridden by zsh-vi-mode
# are configured in zsh-vi-mode-config.zsh's zvm_after_init function

bindkey "''${key[Up]}" up-line-or-search

# kubernetes
source <(kubectl completion zsh)

# help me to fix wrong typed commands
eval "$(pay-respects zsh --alias)"

# Cloudflare Tunnel SSH helper
# Set CLOUDFLARE_TUNNEL_HOST to your tunnel URL, then run cf-ssh
cf-ssh() {
  if [ -z "$CLOUDFLARE_TUNNEL_HOST" ]; then
    echo "Error: CLOUDFLARE_TUNNEL_HOST not set"
    echo "Usage: export CLOUDFLARE_TUNNEL_HOST=beatles-separate-athletes-fantastic.trycloudflare.com"
    echo "       cf-ssh [user@]host"
    return 1
  fi

  local target="${1:-$USER@localhost}"
  ssh -o ProxyCommand="cloudflared access tcp --hostname $CLOUDFLARE_TUNNEL_HOST" "$target"
}
