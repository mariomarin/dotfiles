# User configuration sourced by interactive shells

# aliases {{{

# vim
alias vi=nvim

# git
alias pr="git push-track && gh pr create --fill"
alias checks="gh pr checks"
alias merge="gh pr merge --delete-branch --merge && git pull"
alias approve="gh pr review --approve"

# chezmoi
alias ce="chezmoi edit --apply"

# kubernetes
alias k='kubectl'

# thumbs
alias pick='thumbs -u -r | xsel --clipboard -i'

# xsel
alias xc='xsel --clipboard'
# }}} End aliases

# Temporary Files
if [[ ! -d "$TMPDIR" ]]; then
  export TMPDIR="/tmp/$USER"
  mkdir -p -m 700 "$TMPDIR"
fi

TMPPREFIX="${TMPDIR%/}/zsh"
if [[ ! -d "$TMPPREFIX" ]]; then
  mkdir -p "$TMPPREFIX"
fi

# node
npm config set prefix "$NPM_CONFIG_PREFIX"

# Use GNOME Keyring SSH agent
if [[ -n "$DISPLAY" ]] || [[ -n "$WAYLAND_DISPLAY" ]]; then
  # Primary: GNOME Control Center socket
  if [[ -S "/run/user/$(id -u)/gcr/ssh" ]]; then
    export SSH_AUTH_SOCK="/run/user/$(id -u)/gcr/ssh"
  # Alternative: GNOME Keyring socket location
  elif [[ -S "/run/user/$(id -u)/keyring/ssh" ]]; then
    export SSH_AUTH_SOCK="/run/user/$(id -u)/keyring/ssh"
  fi

  if [[ -n "$SSH_AUTH_SOCK" ]] && command -v ssh-add >/dev/null 2>&1; then
    ssh-add -l >/dev/null 2>&1 || true
  fi
fi

# zoxide (fasd replacement)
eval "$(zoxide init zsh)"

# direnv
eval "$(direnv hook zsh)"

# Zsh configuration
# Start configuration added by Zim install {{{
# User configuration sourced by interactive shells

# Remove path separator from WORDCHARS.
WORDCHARS=${WORDCHARS//[\/]/}

# prefix for git zimfw module
zstyle ':zim:git' aliases-prefix 'g'

# Install missing modules and update ${ZIM_HOME}/init.zsh if missing or outdated.
if [[ ! ${ZIM_HOME}/init.zsh -nt ${ZIM_CONFIG_FILE:-${ZDOTDIR:-${HOME}}/.zimrc} ]]; then
  # Update static initialization script if it's outdated, before sourcing it
  source ${ZIM_HOME}/zimfw.zsh init -q
fi
source ${ZIM_HOME}/init.zsh

# End configuration added by Zim install }}}

# Unalias zimfw git module aliases that conflict with CLI tools
# The git module is configured to use prefix 'g' (set above)
# See ~/.config/zim/modules/git/init.zsh for full alias list
#
# Conflicts:
# - gh: git help (conflicts with GitHub CLI)
# - gt: git tag (conflicts with Graphite CLI)
unalias gh 2>/dev/null
unalias gt 2>/dev/null

# Post-init module configuration

bindkey '^P' history-substring-search-up
bindkey '^N' history-substring-search-down
bindkey '^n' history-substring-search-up
bindkey '^p' history-substring-search-down

bindkey '^y' autosuggest-accept
bindkey "''${key[Up]}" up-line-or-search

# kubernetes
source <(kubectl completion zsh)
eval $(aws-sso completions --shell zsh --source)

# help me to fix wrong typed commands
eval "$(pay-respects zsh --alias)"

# sesh - Tmux session manager
function sesh-sessions() {
  {
    exec </dev/tty
    exec <&1
    local session
    session=$(sesh list -t -c | fzf --height 40% --reverse --border-label ' sesh ' --border --prompt 'âš¡  ')
    [[ -z "$session" ]] && return
    sesh connect $session
  }
}

zle     -N             sesh-sessions
bindkey -M emacs '\es' sesh-sessions
bindkey -M vicmd '\ee' sesh-sessions
bindkey -M viins '\ee' sesh-sessions

