# Tmux configuration management

set shell := ["nu", "-c"]

# OS compatibility check
_check-os:
    #!/usr/bin/env nu
    if $nu.os-info.name == "windows" {
        print "‚ùå Error: Tmux is only available on Unix-like systems (Linux, macOS)"
        print "   Windows does not support tmux. Consider using Windows Terminal with WSL instead."
        exit 1
    }

# Default: reload config
default: _check-os reload

# Reload tmux configuration
reload: _check-os
    tmux source-file ~/.config/tmux/tmux.conf ; tmux display-message "Config reloaded!"

# Install TPM plugins
plugins-install: _check-os
    ~/.local/share/tmux/plugins/tpm/bin/install_plugins

# Update TPM plugins
plugins-update: _check-os
    ~/.local/share/tmux/plugins/tpm/bin/update_plugins all

# Clean unused plugins
plugins-clean: _check-os
    ~/.local/share/tmux/plugins/tpm/bin/clean_plugins

# Show tmux status
status: _check-os
    #!/usr/bin/env nu
    let sessions = (do { tmux list-sessions } | complete)
    if $sessions.exit_code != 0 {
        print "No tmux sessions running"
    } else {
        print $sessions.stdout
        (do { tmux list-windows } | complete | get stdout)
        (do { tmux list-panes } | complete | get stdout)
    }

# Kill tmux server
kill-server: _check-os
    tmux kill-server

# Health check
health: _check-os
    #!/usr/bin/env nu
    print "üîç Tmux Health Check"
    print "=================="
    let version_result = (do { tmux -V } | complete)
    let version = if $version_result.exit_code == 0 { $version_result.stdout | str trim } else { "unknown" }
    print $"‚úì Tmux version: ($version)"
    let config_exists = ("~/.config/tmux/tmux.conf" | path expand | path exists)
    print $"‚úì Config file: (if $config_exists { 'exists' } else { '‚ùå missing' })"
    let tpm_dir = ("~/.local/share/tmux/plugins/tpm" | path expand)
    let tpm_installed = if ($tpm_dir | path exists) { "yes" } else { "‚ùå no" }
    print $"‚úì TPM installed: ($tpm_installed)"
    let plugins_dir = ("~/.local/share/tmux/plugins" | path expand)
    let plugins = if ($plugins_dir | path exists) { (ls $plugins_dir | length) } else { 0 }
    print $"‚úì Plugins installed: ($plugins) plugins"
    let server_result = (do { tmux list-sessions } | complete)
    let server_running = if $server_result.exit_code == 0 { "yes" } else { "no" }
    print $"‚úì Server running: ($server_running)"
    let sessions = if $server_result.exit_code == 0 { ($server_result.stdout | lines | length) } else { 0 }
    print $"‚úì Sessions: ($sessions) active"
    let keys_result = (do { tmux list-keys } | complete)
    let keys = if $keys_result.exit_code == 0 { ($keys_result.stdout | lines | length) } else { 0 }
    print $"‚úì Key bindings: ($keys) configured"
    let env_result = (do { tmux show-environment TERM } | complete)
    let term = if $env_result.exit_code == 0 { ($env_result.stdout | split row '=' | last | str trim) } else { "not in tmux" }
    print $"‚úì Environment: ($term)"
    print ""
