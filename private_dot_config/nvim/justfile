# Neovim configuration management

set shell := ["nu", "-c"]

# Default: sync plugins
default: sync

# Sync/install plugins
sync:
    nvim --headless "+Lazy! sync" +qa

# Update plugins
update:
    nvim --headless "+Lazy! update" +qa

# Clean unused plugins
clean:
    nvim --headless "+Lazy! clean" +qa

# Health check
health:
    #!/usr/bin/env nu
    print "üîç Neovim Health Check"
    print "===================="
    let version_result = (do { nvim --version } | complete)
    let version = if $version_result.exit_code == 0 { $version_result.stdout | lines | first } else { "unknown" }
    print $"‚úì Neovim version: ($version)"
    print $"‚úì Config location: (~/.config/nvim | path expand)"
    let lazy_dir = ("~/.local/share/nvim/lazy" | path expand)
    let plugins = if ($lazy_dir | path exists) { (ls $lazy_dir | where type == dir | length) } else { 0 }
    print $"‚úì LazyVim plugins: ($plugins) installed"
    let parser_dir = ("~/.local/share/nvim/lazy/nvim-treesitter/parser" | path expand)
    let parsers = if ($parser_dir | path exists) { (ls $parser_dir | where name =~ ".so$" | length) } else { 0 }
    print $"‚úì Treesitter parsers: ($parsers) installed"
    let mason_dir = ("~/.local/share/nvim/mason/packages" | path expand)
    let mason = if ($mason_dir | path exists) { (ls $mason_dir | length) } else { 0 }
    print $"‚úì Mason packages: ($mason) installed"
    let syntax_result = (do { nvim --headless -c "try | source init.lua | echo 'valid' | catch | echo 'invalid' | endtry" -c "qa!" } | complete)
    let syntax = if $syntax_result.exit_code == 0 { "valid" } else { "checking..." }
    print $"‚úì Config syntax: ($syntax)"
    print ""
    print "For detailed health check, run: just health-full"

# Full health check
health-full:
    nvim "+checkhealth" "+qa"

# Show plugin status
plugins:
    nvim --headless "+Lazy" "+qa"

# Lint Lua files
lint:
    #!/usr/bin/env nu
    if (which stylua | is-not-empty) {
        let result = (do { stylua --check . } | complete)
        if $result.exit_code != 0 {
            print "‚ùå Lua files need formatting. Run 'just format' to fix."
            exit 1
        }
    } else {
        print "‚ö†Ô∏è  stylua not found"
    }

# Format Lua files
format:
    #!/usr/bin/env nu
    if (which stylua | is-not-empty) {
        stylua .
        print "‚úÖ Lua files formatted"
    } else {
        print "‚ö†Ô∏è  stylua not found"
    }
