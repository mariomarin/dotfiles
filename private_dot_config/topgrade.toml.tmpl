# Topgrade configuration
# Updates all system packages and plugins in one command

[misc]
# Don't update these - handled separately or not needed
disable = [
{{- if ne .chezmoi.os "windows" }}
  "system",     # System update (NixOS uses flakes, not channels)
  "nix",        # Determinate Nix doesn't support upgrade-nix
{{- end }}
  "chezmoi",    # Run via just command instead of built-in
  "containers", # Docker/Podman containers
  "firmware",   # Firmware updates (handle manually)
  "restarts",   # Don't auto-restart services
  "vscode",     # VSCode extensions (using Neovim instead)
  "poetry",     # Poetry packages (not using)
  "yarn",       # Yarn global packages (using pnpm instead)
{{- if ne .chezmoi.os "windows" }}
  "rustup",     # Rustup (managed by Nix on NixOS)
  "bun",        # Bun (managed by NixOS)
{{- end }}
]

# Don't retry failed steps automatically
no_retry = false

# Run inside tmux if available
run_in_tmux = false

# Assume yes for all prompts
assume_yes = false

# Cleanup after updates
cleanup = true

# Custom commands to run at specific times
[pre_commands]
# Ensure Bitwarden vault is unlocked and session is saved
"Bitwarden unlock" = "cd $(chezmoi source-path) && just bw-unlock"

[commands]
# Apply chezmoi dotfiles (loads BW_SESSION automatically via just)
"chezmoi" = "cd $(chezmoi source-path) && just chezmoi-apply"

{{- if ne .chezmoi.os "windows" }}
# Update tmux plugins via TPM
"Tmux Plugins" = "~/.local/share/tmux/plugins/tpm/bin/update_plugins all"
# Update Nix system configuration with flakes (OS-specific)
{{- if eq .chezmoi.os "darwin" }}
"NixOS Flake" = "cd $(chezmoi source-path) && sudo just darwin"
{{- else }}
"NixOS Flake" = "cd $(chezmoi source-path) && just nixos"
{{- end }}
{{- end }}

{{- if eq .chezmoi.os "windows" }}
# Windows-specific: Apply winget configuration (packages and settings)
"Winget Configuration" = "cd $(chezmoi source-path) && just windows-configure"
{{- end }}

{{- if ne .chezmoi.os "windows" }}

[post_commands]
# Add and commit updated lock files to chezmoi after updates
"Commit Neovim plugin updates" = """
set -e  # Exit on error

# Check if lazy-lock.json exists
if [ ! -f ~/.config/nvim/lazy-lock.json ]; then
    exit 0
fi

# Add to chezmoi (force overwrite to avoid prompts)
chezmoi add --force ~/.config/nvim/lazy-lock.json || exit 0

# Navigate to source directory
cd $(chezmoi source-path) || exit 0

# Check if the file has changes (staged or unstaged)
if git diff --staged --quiet private_dot_config/nvim/lazy-lock.json 2>/dev/null && \
   git diff --quiet private_dot_config/nvim/lazy-lock.json 2>/dev/null; then
    # No changes, nothing to commit
    exit 0
fi

# Commit the changes
git add private_dot_config/nvim/lazy-lock.json
git commit -m 'chore(nvim): update lazy-lock.json' || true
"""
{{- end }}

[git]
# Pull git repositories
pull_predefined = false

# Arguments for git pull
arguments = "--rebase --autostash"

{{- if eq .chezmoi.os "linux" }}

[linux]
# NixOS configuration
nix_arguments = "--flake"
nix_env_arguments = "--prebuilt-only"

# Update package managers
apt_arguments = "--only-upgrade"
dnf_arguments = "--refresh"
{{- end }}

{{- if eq .chezmoi.os "windows" }}

[windows]
# Accept all prompts
accept_all_windows_updates = true
# Don't reboot automatically
wsl_update_pre_release = false
# Enable winget updates
enable_winget = true
{{- end }}

[vim]
# Force update vim plugins
force_plug_update = false

[npm]
# NPM configuration
# Note: use_pnpm was removed in newer versions, pnpm is auto-detected

[python]
# Enable pip updates
enable_pip_review = true
enable_pip_review_local = false
enable_pipupgrade = false

# [tmux] section has been removed as it's not a valid topgrade section
# Tmux plugin updates are now handled differently in newer topgrade versions

[distrobox]
# Update distrobox containers
use_root = false
