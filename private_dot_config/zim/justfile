# Zim framework management

set shell := ["nu", "-c"]

# Default: update modules
default: update

# Install Zim
install:
    curl -fsSL https://raw.githubusercontent.com/zimfw/install/master/install.zsh | zsh

# Update Zim modules
update:
    zimfw update

# Uninstall Zim modules
uninstall:
    zimfw uninstall

# Upgrade Zim itself
upgrade:
    zimfw upgrade

# Clean Zim cache and compiled files
clean:
    zimfw clean
    zimfw clean-compiled

# Compile Zim modules for faster loading
compile:
    zimfw compile

# Clean and recompile all Zim modules
recompile:
    #!/usr/bin/env nu
    print "üßπ Cleaning compiled files..."
    zimfw clean-compiled
    print "üî® Recompiling modules..."
    zimfw compile
    print "‚úÖ Recompilation complete"

# List installed modules
list:
    zimfw list

# Show Zim version
version:
    zimfw version

# Build custom completions
completions:
    #!/usr/bin/env nu
    print "Regenerating custom completions..."
    let modules = (glob "modules/*/init.zsh")
    for module in $modules {
        print $"Processing ($module)..."
        zsh -c $"source ($module)"
    }

# Health check
health:
    #!/usr/bin/env nu
    print "üîç Zim Health Check"
    print "=================="
    let zim_dir = ("~/.zim" | path expand)
    let zim_installed = if ($zim_dir | path exists) { "yes" } else { "‚ùå no" }
    print $"‚úì Zim installed: ($zim_installed)"
    let version_result = (do { zimfw version } | complete)
    let version = if $version_result.exit_code == 0 { $version_result.stdout | lines | first } else { "not installed" }
    print $"‚úì Zim version: ($version)"
    let config_exists = ("~/.config/zim/zimrc" | path expand | path exists)
    print $"‚úì Config file: (if $config_exists { 'exists' } else { '‚ùå missing' })"
    let modules_dir = ("~/.zim/modules" | path expand)
    let modules_count = if ($modules_dir | path exists) { (ls $modules_dir | length) } else { 0 }
    print $"‚úì Modules installed: ($modules_count) modules"
    let custom_modules = if ("modules" | path exists) { (ls modules | length) } else { 0 }
    print $"‚úì Custom modules: ($custom_modules) custom"
    let compiled = (glob ($zim_dir | path join "**" "*.zwc") | length)
    print $"‚úì Compiled files: ($compiled) files"
    let cache_dir = ("~/.cache/zim" | path expand)
    let cache_files = if ($cache_dir | path exists) { (glob ($cache_dir | path join "compdump*") | length) } else { 0 }
    print $"‚úì Completion cache: ($cache_files) files"
    let zsh_result = (do { zsh --version } | complete)
    let zsh_version = if $zsh_result.exit_code == 0 { $zsh_result.stdout | lines | first } else { "unknown" }
    print $"‚úì Zsh version: ($zsh_version)"
    print ""
