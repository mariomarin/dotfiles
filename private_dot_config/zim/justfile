# Zim framework management

set shell := ["nu", "-c"]

# OS compatibility check
_check-os:
    #!/usr/bin/env nu
    if (sys | get host.name) == "Windows" {
        print "‚ùå Error: Zim (Zsh framework) is only available on Unix-like systems"
        print "   Windows does not support Zsh natively. Consider using WSL for Zsh."
        exit 1
    }

# Default: update modules
default: _check-os update

# Install Zim
install: _check-os
    curl -fsSL https://raw.githubusercontent.com/zimfw/install/master/install.zsh | zsh

# Update Zim modules
update: _check-os
    zimfw update

# Uninstall Zim modules
uninstall: _check-os
    zimfw uninstall

# Upgrade Zim itself
upgrade: _check-os
    zimfw upgrade

# Clean Zim cache and compiled files
clean: _check-os
    zimfw clean
    zimfw clean-compiled

# Compile Zim modules for faster loading
compile: _check-os
    zimfw compile

# List installed modules
list: _check-os
    zimfw list

# Show Zim version
version: _check-os
    zimfw version

# Build custom completions
completions: _check-os
    #!/usr/bin/env nu
    print "Regenerating custom completions..."
    let modules = (glob "modules/*/init.zsh")
    for module in $modules {
        print $"Processing ($module)..."
        zsh -c $"source ($module)"
    }

# Health check
health: _check-os
    #!/usr/bin/env nu
    print "üîç Zim Health Check"
    print "=================="
    let zim_dir = ("~/.zim" | path expand)
    let zim_installed = if ($zim_dir | path exists) { "yes" } else { "‚ùå no" }
    print $"‚úì Zim installed: ($zim_installed)"
    let version_result = (do { zimfw version } | complete)
    let version = if $version_result.exit_code == 0 { $version_result.stdout | lines | first } else { "not installed" }
    print $"‚úì Zim version: ($version)"
    let config_exists = ("~/.config/zim/zimrc" | path expand | path exists)
    print $"‚úì Config file: (if $config_exists { 'exists' } else { '‚ùå missing' })"
    let modules_dir = ("~/.zim/modules" | path expand)
    let modules_count = if ($modules_dir | path exists) { (ls $modules_dir | length) } else { 0 }
    print $"‚úì Modules installed: ($modules_count) modules"
    let custom_modules = if ("modules" | path exists) { (ls modules | length) } else { 0 }
    print $"‚úì Custom modules: ($custom_modules) custom"
    let compiled = (glob ($zim_dir | path join "**" "*.zwc") | length)
    print $"‚úì Compiled files: ($compiled) files"
    let cache_dir = ("~/.cache/zim" | path expand)
    let cache_files = if ($cache_dir | path exists) { (glob ($cache_dir | path join "compdump*") | length) } else { 0 }
    print $"‚úì Completion cache: ($cache_files) files"
    let zsh_result = (do { zsh --version } | complete)
    let zsh_version = if $zsh_result.exit_code == 0 { $zsh_result.stdout | lines | first } else { "unknown" }
    print $"‚úì Zsh version: ($zsh_version)"
    print ""
