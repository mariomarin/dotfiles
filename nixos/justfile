# NixOS rebuild commands for multi-machine setup

# Default target - first-time setup or switch
default:
    @just switch

# Default host (physical T470)
HOST := env_var_or_default("HOST", "nixos")

# First-time NixOS setup (use this after fresh NixOS install)
first-time:
    #!/usr/bin/env bash
    echo "ðŸš€ First-time NixOS setup..."
    echo "  This will:"
    echo "  1. Enable flakes in current session"
    echo "  2. Build and switch to flake configuration"
    echo ""

    # Enable flakes for this command
    echo "ðŸ“¦ Building NixOS configuration with flakes..."
    sudo nixos-rebuild switch --flake .#{{HOST}} \
        --extra-experimental-features "nix-command flakes"

    echo ""
    echo "âœ… First-time setup complete!"
    echo "ðŸ’¡ Flakes are now enabled system-wide. Future rebuilds use: just switch"

# Local build and switch commands
switch:
    sudo nixos-rebuild switch --flake .#{{HOST}}

test:
    sudo nixos-rebuild test --flake .#{{HOST}}

boot:
    sudo nixos-rebuild boot --flake .#{{HOST}}

build:
    sudo nixos-rebuild build --flake .#{{HOST}}

# VM-specific targets
vm-switch:
    sudo nixos-rebuild switch --flake .#vm-headless

vm-test:
    sudo nixos-rebuild test --flake .#vm-headless

vm-build:
    sudo nixos-rebuild build --flake .#vm-headless

# Remote deployment targets
remote-switch TARGET_HOST BUILD_HOST="":
    #!/usr/bin/env bash
    if [ -z "{{TARGET_HOST}}" ]; then
        echo "Error: TARGET_HOST not set. Usage: just remote-switch TARGET_HOST=user@host"
        exit 1
    fi
    nixos-rebuild switch --flake .#{{HOST}} \
        --target-host {{TARGET_HOST}} \
        --use-remote-sudo \
        {{ if BUILD_HOST != "" { "--build-host " + BUILD_HOST } else { "" } }}

remote-test TARGET_HOST BUILD_HOST="":
    #!/usr/bin/env bash
    if [ -z "{{TARGET_HOST}}" ]; then
        echo "Error: TARGET_HOST not set. Usage: just remote-test TARGET_HOST=user@host"
        exit 1
    fi
    nixos-rebuild test --flake .#{{HOST}} \
        --target-host {{TARGET_HOST}} \
        --use-remote-sudo \
        {{ if BUILD_HOST != "" { "--build-host " + BUILD_HOST } else { "" } }}

# Deploy VM configuration to remote host
deploy-vm TARGET_HOST BUILD_HOST="":
    #!/usr/bin/env bash
    if [ -z "{{TARGET_HOST}}" ]; then
        echo "Error: TARGET_HOST not set. Usage: just deploy-vm TARGET_HOST=user@host"
        exit 1
    fi
    nixos-rebuild switch --flake .#vm-headless \
        --target-host {{TARGET_HOST}} \
        --use-remote-sudo \
        {{ if BUILD_HOST != "" { "--build-host " + BUILD_HOST } else { "" } }}

# Flake management
update:
    nix flake update

check:
    nix flake check

show:
    nix flake show

# Show available hosts
hosts:
    #!/usr/bin/env bash
    echo "Available NixOS configurations:"
    echo "  - nixos       : ThinkPad T470 (desktop)"
    echo "  - vm-headless : Headless VM (SSH only)"
    echo ""
    echo "Current HOST: {{HOST}}"

# Health check
health:
    #!/usr/bin/env bash
    echo "ðŸ” NixOS Health Check for {{HOST}}"
    echo "================================"
    echo -n "âœ“ NixOS version: "; nixos-version
    echo -n "âœ“ Hostname: "; hostname
    echo -n "âœ“ Current generation: "; sudo nix-env --list-generations --profile /nix/var/nix/profiles/system | tail -1
    echo -n "âœ“ Flake status: "; test -f flake.lock && echo "locked" || echo "âš ï¸  not locked"
    echo -n "âœ“ Configuration syntax: "; nix-instantiate --parse configuration.nix > /dev/null 2>&1 && echo "valid" || echo "âŒ invalid"
    echo -n "âœ“ Flake check: "; nix flake check --no-build 2>/dev/null && echo "passed" || echo "âš ï¸  warnings"
    echo -n "âœ“ Nix daemon: "; systemctl is-active nix-daemon.service || echo "not running"
    echo -n "âœ“ Disk usage: "; du -sh /nix/store 2>/dev/null | cut -f1
    echo ""

# Help target
help:
    @echo "NixOS Multi-Machine Build Targets"
    @echo "================================="
    @echo ""
    @echo "Local builds (default HOST=nixos):"
    @echo "  just switch              # Build and switch to HOST configuration"
    @echo "  just test                # Test HOST configuration"
    @echo "  just boot                # Update boot configuration"
    @echo "  just build               # Build without switching"
    @echo "  just switch HOST=vm-headless  # Build vm-headless locally"
    @echo ""
    @echo "VM-specific shortcuts:"
    @echo "  just vm-switch           # Build and switch to vm-headless"
    @echo "  just vm-test             # Test vm-headless configuration"
    @echo ""
    @echo "Remote deployment:"
    @echo "  just remote-switch TARGET_HOST=user@host    # Deploy HOST to remote"
    @echo "  just deploy-vm TARGET_HOST=user@vm-ip       # Deploy VM config"
    @echo "  just remote-test TARGET_HOST=user@host      # Test on remote"
    @echo ""
    @echo "Optional: BUILD_HOST=user@build-server for remote building"
    @echo ""
    @echo "Utilities:"
    @echo "  just hosts               # Show available configurations"
    @echo "  just health              # System health check"
    @echo "  just update              # Update flake inputs"
    @echo "  just check               # Validate flake"
    @echo ""
    @echo "Examples:"
    @echo "  just switch                                  # Local T470"
    @echo "  just vm-switch                               # Local VM config"
    @echo "  just deploy-vm TARGET_HOST=admin@192.168.1.100"
    @echo "  just remote-switch HOST=nixos TARGET_HOST=user@backup-t470"
