# Chezmoi operations

set shell := ["nu", "-c"]
set dotenv-filename := ".env.local"
set dotenv-load

# Default target
default: apply

# Apply dotfiles changes
apply:
    chezmoi apply --no-tty

# Show what would change
diff:
    chezmoi diff

# Quick apply without updates
quick-apply:
    CHEZMOI_SKIP_UPDATES=1 chezmoi apply --no-tty

# Initialize chezmoi with repository
init REPO="git@github.com:mariomarin/dotfiles.git":
    chezmoi init {{REPO}} --apply

# Install chezmoi
install:
    curl -sfL https://git.io/chezmoi | sh

# Show status
status:
    chezmoi status

# Add a file to chezmoi
add FILE:
    chezmoi add {{FILE}}

# Edit a managed file
edit FILE:
    chezmoi edit {{FILE}}

# Update from repository
update:
    chezmoi git pull -- --rebase && chezmoi diff

# Health check
health:
    #!/usr/bin/env nu
    print "üîç Chezmoi Health Check"
    print "======================"
    let version_result = (do { chezmoi --version } | complete)
    let version = if $version_result.exit_code == 0 { $version_result.stdout | lines | first } else { "unknown" }
    print $"‚úì Chezmoi version: ($version)"
    let source_result = (do { chezmoi source-path } | complete)
    let source = if $source_result.exit_code == 0 { $source_result.stdout | str trim } else { "unknown" }
    print $"‚úì Source directory: ($source)"
    let config_exists = ("~/.config/chezmoi/chezmoi.toml" | path expand | path exists)
    print $"‚úì Config file: (if $config_exists { 'exists' } else { 'using defaults' })"
    let managed_result = (do { chezmoi managed } | complete)
    let managed_count = if $managed_result.exit_code == 0 { $managed_result.stdout | lines | length } else { 0 }
    print $"‚úì Managed files: ($managed_count)"
    let status_result = (do { chezmoi status } | complete)
    let status_count = if $status_result.exit_code == 0 { $status_result.stdout | lines | length } else { 0 }
    print $"‚úì Modified files: ($status_count) files"
    cd $source
    let git_status_result = (do { git status --porcelain } | complete)
    let git_status = if $git_status_result.exit_code == 0 {
        let changes = ($git_status_result.stdout | lines | length)
        if $changes == 0 { "clean" } else { $"($changes) changes" }
    } else { "unknown" }
    print $"‚úì Git status: ($git_status)"
    let remote_result = (do { git remote get-url origin } | complete)
    let remote = if $remote_result.exit_code == 0 { $remote_result.stdout | str trim } else { "no remote" }
    print $"‚úì Git remote: ($remote)"
    let config_path = ("~/.config/chezmoi/chezmoi.toml" | path expand)
    let auto_commit = if ($config_path | path exists) {
        let content = (open $config_path | to text)
        if ($content | str contains "autoCommit") and ($content | str contains "true") { "enabled" } else { "disabled" }
    } else { "disabled" }
    print $"‚úì Auto commit: ($auto_commit)"
    print ""
