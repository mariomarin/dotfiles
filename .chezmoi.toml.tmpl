{{- /* ══════════════════════════════════════════════════════════════════════════
   Machine detection and defaults

   Override any value by editing ~/.config/chezmoi/chezmoi.toml after init:

   [data]
       username = "yourname"
   [data.machineConfig.features]
       kanata = false
   ══════════════════════════════════════════════════════════════════════════ */ -}}

{{- $hostname := .chezmoi.hostname -}}
{{- $username := .chezmoi.username -}}

{{- /* Detect environment */ -}}
{{- $codespaces := env "CODESPACES" | not | not -}}
{{- $isWSL := env "WSL_DISTRO_NAME" | not | not -}}

{{- /* Determine machine type and features based on environment */ -}}
{{- $isServer := or $codespaces $isWSL (hasPrefix "vm-" $hostname) -}}
{{- $isDesktop := not $isServer -}}

{{- /* Kanata: enabled on known desktop machines, disabled by default for others */ -}}
{{- $knownKanataMachines := list "dendrite" "malus" "prion" -}}
{{- $hasKanata := has $hostname $knownKanataMachines -}}

{{- /* Set machine type string */ -}}
{{- $machineType := "desktop" -}}
{{- if $isWSL -}}
  {{- $machineType = "wsl" -}}
{{- else if $isServer -}}
  {{- $machineType = "server" -}}
{{- end -}}

[bitwarden]
    command = "bw"

[data]
    username = {{ $username | quote }}
    machineType = {{ $machineType | quote }}
    codespaces = {{ $codespaces }}

    [data.machineConfig]
        hostname = {{ $hostname | quote }}
        type = {{ $machineType | quote }}

        [data.machineConfig.features]
            desktop = {{ $isDesktop }}
            kanata = {{ $hasKanata }}
            audio = {{ and $isDesktop (not $isWSL) }}
            bluetooth = {{ and $isDesktop (not $isWSL) }}
            wsl = {{ $isWSL }}