{{- /* Machine detection - environment-based with hostname overrides for Nix machines */ -}}

{{- $hostname := .chezmoi.hostname -}}
{{- $username := .chezmoi.username -}}

{{- /* Environment detection */ -}}
{{- $codespaces := env "CODESPACES" | not | not -}}
{{- $isWSL := env "WSL_DISTRO_NAME" | not | not -}}
{{- $isNixOS := and (hasKey .chezmoi "osRelease") (eq (index .chezmoi.osRelease "id" | default "") "nixos") -}}
{{- $hasChef := or (stat "/opt/chef") (lookPath "chef-client") -}}

{{- /* Platform detection: environment first, then known hostnames for Nix */ -}}
{{- $platform := "" -}}
{{- $knownNixHosts := list "malus" "dendrite" "symbiont" "mitosis" -}}

{{- if eq .chezmoi.os "darwin" -}}
  {{- if $hasChef -}}
    {{- $platform = "darwin-brew" -}}
  {{- else -}}
    {{- $platform = "darwin" -}}
  {{- end -}}
{{- else if eq .chezmoi.os "linux" -}}
  {{- if $isNixOS -}}
    {{- if $isWSL -}}
      {{- $platform = "nixos-wsl" -}}
    {{- else -}}
      {{- $platform = "nixos" -}}
    {{- end -}}
  {{- else if has $hostname $knownNixHosts -}}
    {{- /* Known Nix host but not detected as NixOS - probably first run */ -}}
    {{- $platform = "nixos" -}}
  {{- else -}}
    {{- $platform = "linux-apt" -}}
  {{- end -}}
{{- else if eq .chezmoi.os "windows" -}}
  {{- $platform = "windows" -}}
{{- end -}}

{{- /* Machine type */ -}}
{{- $isServer := or $codespaces (not (or (eq .chezmoi.os "darwin") (eq .chezmoi.os "windows"))) -}}
{{- if eq $platform "darwin" "darwin-brew" -}}
  {{- $isServer = false -}}
{{- end -}}
{{- $isDesktop := not $isServer -}}

{{- /* Kanata: desktops with physical keyboards */ -}}
{{- $hasKanata := and $isDesktop (not $codespaces) (not $isWSL) -}}

{{- /* Machine type string */ -}}
{{- $machineType := "desktop" -}}
{{- if $isWSL -}}
  {{- $machineType = "wsl" -}}
{{- else if $isServer -}}
  {{- $machineType = "server" -}}
{{- end -}}

[bitwarden]
    command = "bw"

[data]
    username = {{ $username | quote }}
    machineType = {{ $machineType | quote }}
    codespaces = {{ $codespaces }}

    [data.machineConfig]
        hostname = {{ $hostname | quote }}
        type = {{ $machineType | quote }}
        platform = {{ $platform | quote }}

        [data.machineConfig.features]
            desktop = {{ $isDesktop }}
            kanata = {{ $hasKanata }}
            audio = {{ and $isDesktop (not $isWSL) (not $codespaces) }}
            bluetooth = {{ and $isDesktop (not $isWSL) (not $codespaces) }}
            wsl = {{ $isWSL }}
