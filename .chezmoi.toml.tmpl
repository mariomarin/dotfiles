{{- /* Get hostname from config file, HOSTNAME env var, or system hostname */ -}}
{{- $hostname := .hostname | default (env "HOSTNAME") | default .chezmoi.hostname -}}

{{- /* Detect environment */ -}}
{{- $codespaces := env "CODESPACES" | not | not -}}
{{- $isServer := false -}}
{{- $isDesktop := false -}}
{{- $hasKmonad := false -}}
{{- $isWSL := false -}}

{{- /* Detect WSL environment */ -}}
{{- $wslEnv := env "WSL_DISTRO_NAME" -}}
{{- if $wslEnv -}}
  {{- $isWSL = true -}}
{{- end -}}

{{- /* Determine machine type based on hostname and environment */ -}}
{{- if $codespaces -}}
  {{- $isServer = true -}}
{{- else if $isWSL -}}
  {{- $isServer = true -}}
  {{- /* WSL is treated as a server (headless, CLI-only) */ -}}
{{- else if eq $hostname "nixos" -}}
  {{- $isDesktop = true -}}
  {{- $hasKmonad = true -}}
{{- else if hasPrefix "vm-" $hostname -}}
  {{- $isServer = true -}}
{{- else -}}
  {{- /* Default to desktop for unknown hosts */ -}}
  {{- $isDesktop = true -}}
{{- end -}}

{{- /* Set machine type string */ -}}
{{- $machineType := "laptop" -}}
{{- if $isServer -}}
  {{- $machineType = "server" -}}
{{- end -}}
{{- if $isWSL -}}
  {{- $machineType = "wsl" -}}
{{- end -}}

[bitwarden]
    command = "bw"

[data]
    machineType = {{ $machineType | quote }}
    codespaces = {{ $codespaces }}

    [data.machineConfig]
        hostname = {{ $hostname | quote }}
        type = {{ $machineType | quote }}

        [data.machineConfig.features]
            desktop = {{ $isDesktop }}
            kanata = {{ $hasKmonad }}
            audio = {{ and $isDesktop (not $isWSL) }}
            bluetooth = {{ and $isDesktop (not $isWSL) }}
            wsl = {{ $isWSL }}