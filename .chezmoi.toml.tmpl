{{- /* ══════════════════════════════════════════════════════════════════════════
   Machine detection and defaults

   Override any value by editing ~/.config/chezmoi/chezmoi.toml after init:

   [data]
       username = "yourname"
   [data.machineConfig.features]
       kanata = false
   ══════════════════════════════════════════════════════════════════════════ */ -}}

{{- $hostname := .chezmoi.hostname -}}
{{- $username := .chezmoi.username -}}

{{- /* Detect environment */ -}}
{{- $codespaces := env "CODESPACES" | not | not -}}
{{- $isWSL := env "WSL_DISTRO_NAME" | not | not -}}

{{- /* Determine machine type and features based on environment */ -}}
{{- $knownServers := list "mitosis" "ribosome" -}}
{{- $isServer := or $codespaces $isWSL (hasPrefix "vm-" $hostname) (has $hostname $knownServers) -}}
{{- $isDesktop := not $isServer -}}

{{- /* Kanata: enabled on known desktop machines, disabled by default for others */ -}}
{{- $knownKanataMachines := list "dendrite" "malus" "prion" "axon" -}}
{{- $hasKanata := has $hostname $knownKanataMachines -}}

{{- /* Platform detection based on hostname and OS */ -}}
{{- $platform := "" -}}
{{- if eq .chezmoi.os "darwin" -}}
  {{- if eq $hostname "axon" -}}
    {{- $platform = "darwin-brew" -}}
  {{- else -}}
    {{- $platform = "darwin" -}}
  {{- end -}}
{{- else if eq .chezmoi.os "linux" -}}
  {{- if eq $hostname "ribosome" -}}
    {{- $platform = "linux-apt" -}}
  {{- else if $isWSL -}}
    {{- $platform = "nixos-wsl" -}}
  {{- else -}}
    {{- $platform = "nixos" -}}
  {{- end -}}
{{- else if eq .chezmoi.os "windows" -}}
  {{- $platform = "windows" -}}
{{- end -}}

{{- /* Set machine type string */ -}}
{{- $machineType := "desktop" -}}
{{- if $isWSL -}}
  {{- $machineType = "wsl" -}}
{{- else if $isServer -}}
  {{- $machineType = "server" -}}
{{- end -}}

[bitwarden]
    command = "bw"

[data]
    username = {{ $username | quote }}
    machineType = {{ $machineType | quote }}
    codespaces = {{ $codespaces }}

    [data.machineConfig]
        hostname = {{ $hostname | quote }}
        type = {{ $machineType | quote }}
        platform = {{ $platform | quote }}

        [data.machineConfig.features]
            desktop = {{ $isDesktop }}
            kanata = {{ $hasKanata }}
            audio = {{ and $isDesktop (not $isWSL) }}
            bluetooth = {{ and $isDesktop (not $isWSL) }}
            wsl = {{ $isWSL }}