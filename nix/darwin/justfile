# nix-darwin rebuild commands

set shell := ["nu", "-c"]

# Default target
default:
    @just switch

# Auto-detect hostname or use HOSTNAME environment variable
# Bootstrap script sets HOSTNAME before calling just, so static fallback is sufficient
HOST := env_var_or_default("HOSTNAME", "malus")

# First-time nix-darwin setup
first-time:
    nu darwin.nu first-time {{HOST}}

# Local build and switch
switch:
    darwin-rebuild switch --flake ../nixos#{{HOST}}

test:
    darwin-rebuild check --flake ../nixos#{{HOST}}

build:
    darwin-rebuild build --flake ../nixos#{{HOST}}

# Flake management (runs in nixos directory where actual flake.nix lives)
update:
    cd ../nixos && nix flake update

check:
    cd ../nixos && nix flake check

show:
    cd ../nixos && nix flake show

# Show available hosts
hosts:
    nu darwin.nu hosts {{HOST}}

# Health check
health:
    nu darwin.nu health

# Help
help:
    @echo "nix-darwin Build Targets"
    @echo "======================="
    @echo ""
    @echo "First-time setup:"
    @echo "  just first-time          # Install nix-darwin and apply config"
    @echo ""
    @echo "Regular use:"
    @echo "  just switch              # Build and switch to configuration"
    @echo "  just test                # Test configuration"
    @echo "  just build               # Build without switching"
    @echo ""
    @echo "Utilities:"
    @echo "  just hosts               # Show available configurations"
    @echo "  just health              # System health check"
    @echo "  just update              # Update flake inputs"
    @echo "  just check               # Validate flake"
    @echo ""
    @echo "Current HOST: {{HOST}}"
    @echo "Override with: just switch HOST=other-hostname"
