# nix-darwin rebuild commands

set shell := ["nu", "-c"]

# Default target
default:
    @just switch

# Auto-detect hostname or use HOSTNAME environment variable
# Bootstrap script sets HOSTNAME before calling just, so static fallback is sufficient
HOST := env_var_or_default("HOSTNAME", "malus")

# First-time nix-darwin setup
first-time:
    #!/usr/bin/env nu
    print "üöÄ First-time nix-darwin setup..."
    print "  This will install nix-darwin and apply the configuration"
    print ""
    print "‚ö†Ô∏è  Note: This assumes Nix is already installed via Determinate Systems installer"
    print ""
    print "üì¶ Installing nix-darwin..."
    # Run darwin-rebuild from nix-darwin flake (uses master/unstable)
    let flake_ref = "nix-darwin/master#darwin-rebuild"
    let config_ref = ".#{{HOST}}"
    ^sudo ^nix run $flake_ref -- switch --flake $config_ref
    print ""
    print "‚úÖ nix-darwin installed!"
    print "üí° Future rebuilds: just darwin"

# Local build and switch
switch:
    darwin-rebuild switch --flake .#{{HOST}}

test:
    darwin-rebuild check --flake .#{{HOST}}

build:
    darwin-rebuild build --flake .#{{HOST}}

# Flake management
update:
    nix flake update

check:
    nix flake check

show:
    nix flake show

# Show available hosts
hosts:
    #!/usr/bin/env nu
    print "Available nix-darwin configurations:"
    print "  - {{HOST}} : This Mac (detected via scutil)"
    print ""
    print "Current HOST: {{HOST}}"
    print ""
    print "To build for a different host:"
    print "  just switch HOST=other-hostname"

# Health check
health:
    #!/usr/bin/env nu
    print "üîç nix-darwin Health Check"
    print "=========================="
    let hostname_result = (do { ^scutil --get LocalHostName } | complete)
    let hostname = if $hostname_result.exit_code == 0 { $hostname_result.stdout | str trim } else { "unknown" }
    print $"‚úì Hostname: ($hostname)"
    let macos_result = (do { ^sw_vers -productVersion } | complete)
    let macos = if $macos_result.exit_code == 0 { $macos_result.stdout | str trim } else { "unknown" }
    print $"‚úì macOS version: ($macos)"
    let arch_result = (do { ^uname -m } | complete)
    let arch = if $arch_result.exit_code == 0 { $arch_result.stdout | str trim } else { "unknown" }
    print $"‚úì Architecture: ($arch)"
    let nix_result = (do { ^nix --version } | complete)
    let nix_version = if $nix_result.exit_code == 0 { $nix_result.stdout | str trim } else { "not installed" }
    print $"‚úì Nix version: ($nix_version)"
    let darwin_rebuild_exists = (which darwin-rebuild | is-not-empty)
    print $"‚úì darwin-rebuild: (if $darwin_rebuild_exists { 'installed' } else { '‚ùå not installed' })"
    let flake_path = "flake.nix"
    let flake_exists = ($flake_path | path exists)
    print $"‚úì Flake exists: (if $flake_exists { 'yes' } else { '‚ùå no' })"
    let config_dir = ("/etc/nix-darwin" | path exists)
    print $"‚úì nix-darwin config: (if $config_dir { 'installed' } else { 'not installed (run: just first-time)' })"
    print ""

# Help
help:
    @echo "nix-darwin Build Targets"
    @echo "======================="
    @echo ""
    @echo "First-time setup:"
    @echo "  just first-time          # Install nix-darwin and apply config"
    @echo ""
    @echo "Regular use:"
    @echo "  just switch              # Build and switch to configuration"
    @echo "  just test                # Test configuration"
    @echo "  just build               # Build without switching"
    @echo ""
    @echo "Utilities:"
    @echo "  just hosts               # Show available configurations"
    @echo "  just health              # System health check"
    @echo "  just update              # Update flake inputs"
    @echo "  just check               # Validate flake"
    @echo ""
    @echo "Current HOST: {{HOST}}"
    @echo "Override with: just switch HOST=other-hostname"
