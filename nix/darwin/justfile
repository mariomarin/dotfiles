# nix-darwin rebuild commands

set shell := ["nu", "-c"]

# Default target
default:
    @just switch

# Auto-detect hostname or use HOSTNAME environment variable
HOST := env_var_or_default("HOSTNAME", "malus")

# Get username from chezmoi config (falls back to system user)
USER := env_var_or_default("NIX_USER", `chezmoi data --format json | from json | get -i username | default (whoami)`)

# First-time nix-darwin setup
first-time:
    nu darwin.nu first-time {{HOST}}

# Generate user.nix from chezmoi config before building
[private]
gen-user:
    "# Generated by justfile from chezmoi config\n{ username = \"{{USER}}\"; }\n" | save -f ../nixos/user.nix

# Local build and switch
switch: gen-user
    darwin-rebuild switch --flake ../nixos#{{HOST}}

test: gen-user
    darwin-rebuild check --flake ../nixos#{{HOST}}

build: gen-user
    darwin-rebuild build --flake ../nixos#{{HOST}}

# Flake management (runs in nixos directory where actual flake.nix lives)
update:
    cd ../nixos && nix flake update

check:
    cd ../nixos && nix flake check

show:
    cd ../nixos && nix flake show

# Show available hosts
hosts:
    nu darwin.nu hosts {{HOST}}

# Health check
health:
    nu darwin.nu health

# Help
help:
    @echo "nix-darwin Build Targets"
    @echo "======================="
    @echo ""
    @echo "First-time setup:"
    @echo "  just first-time          # Install nix-darwin and apply config"
    @echo ""
    @echo "Regular use:"
    @echo "  just switch              # Build and switch to configuration"
    @echo "  just test                # Test configuration"
    @echo "  just build               # Build without switching"
    @echo ""
    @echo "Utilities:"
    @echo "  just hosts               # Show available configurations"
    @echo "  just health              # System health check"
    @echo "  just update              # Update flake inputs"
    @echo "  just check               # Validate flake"
    @echo ""
    @echo "Current HOST: {{HOST}}"
    @echo "Override with: just switch HOST=other-hostname"
