# NixOS rebuild commands for multi-machine setup

set shell := ["nu", "-c"]

# OS compatibility check
_check-os:
    #!/usr/bin/env nu
    if (sys host).name == "Windows" {
        print "‚ùå Error: NixOS commands are only available on Linux systems"
        print "   This justfile manages NixOS system configuration and cannot run on Windows"
        exit 1
    }

# Default target - first-time setup or switch
default: _check-os
    @just switch

# Default host (dendrite - portable workstation)
HOST := env_var_or_default("HOST", "dendrite")

# First-time NixOS setup (use this after fresh NixOS install)
first-time: _check-os
    #!/usr/bin/env nu
    print "üöÄ First-time NixOS setup..."
    print "  This will:"
    print "  1. Enable flakes in current session"
    print "  2. Build and switch to flake configuration"
    print ""
    print "üì¶ Building NixOS configuration with flakes..."
    sudo nixos-rebuild switch --flake $".#{{HOST}}" --extra-experimental-features "nix-command flakes"
    print ""
    print "‚úÖ First-time setup complete!"
    print "üí° Flakes are now enabled system-wide. Future rebuilds use: just switch"

# Local build and switch commands
switch: _check-os
    sudo nixos-rebuild switch --flake .#{{HOST}}

test: _check-os
    sudo nixos-rebuild test --flake .#{{HOST}}

boot: _check-os
    sudo nixos-rebuild boot --flake .#{{HOST}}

build: _check-os
    sudo nixos-rebuild build --flake .#{{HOST}}

# VM-specific targets
vm-switch: _check-os
    sudo nixos-rebuild switch --flake .#mitosis

vm-test: _check-os
    sudo nixos-rebuild test --flake .#mitosis

vm-build: _check-os
    sudo nixos-rebuild build --flake .#mitosis

# Remote deployment targets
remote-switch TARGET_HOST BUILD_HOST="": _check-os
    #!/usr/bin/env nu
    if ("{{TARGET_HOST}}" | is-empty) {
        print "Error: TARGET_HOST not set. Usage: just remote-switch TARGET_HOST=user@host"
        exit 1
    }
    let build_host_flag = if ("{{BUILD_HOST}}" | is-not-empty) { ["--build-host" "{{BUILD_HOST}}"] } else { [] }
    nixos-rebuild switch --flake $".#{{HOST}}" --target-host {{TARGET_HOST}} --use-remote-sudo ...$build_host_flag

remote-test TARGET_HOST BUILD_HOST="": _check-os
    #!/usr/bin/env nu
    if ("{{TARGET_HOST}}" | is-empty) {
        print "Error: TARGET_HOST not set. Usage: just remote-test TARGET_HOST=user@host"
        exit 1
    }
    let build_host_flag = if ("{{BUILD_HOST}}" | is-not-empty) { ["--build-host" "{{BUILD_HOST}}"] } else { [] }
    nixos-rebuild test --flake $".#{{HOST}}" --target-host {{TARGET_HOST}} --use-remote-sudo ...$build_host_flag

# Deploy VM configuration to remote host
deploy-vm TARGET_HOST BUILD_HOST="": _check-os
    #!/usr/bin/env nu
    if ("{{TARGET_HOST}}" | is-empty) {
        print "Error: TARGET_HOST not set. Usage: just deploy-vm TARGET_HOST=user@host"
        exit 1
    }
    let build_host_flag = if ("{{BUILD_HOST}}" | is-not-empty) { ["--build-host" "{{BUILD_HOST}}"] } else { [] }
    nixos-rebuild switch --flake $".#mitosis" --target-host {{TARGET_HOST}} --use-remote-sudo ...$build_host_flag

# Flake management
update: _check-os
    nix flake update

check: _check-os
    nix flake check

show: _check-os
    nix flake show

# Show available hosts
hosts: _check-os
    #!/usr/bin/env nu
    print "Available NixOS configurations:"
    print "  - dendrite    : ThinkPad T470 portable workstation"
    print "  - mitosis     : Virtual machine for testing and replication"
    print ""
    print $"Current HOST: {{HOST}}"

# Health check
health: _check-os
    #!/usr/bin/env nu
    print "üîç NixOS Health Check for {{HOST}}"
    print "================================"
    let version_result = (do { nixos-version } | complete)
    let version = if $version_result.exit_code == 0 { $version_result.stdout | str trim } else { "unknown" }
    print $"‚úì NixOS version: ($version)"
    let hostname_result = (do { hostname } | complete)
    let hostname = if $hostname_result.exit_code == 0 { $hostname_result.stdout | str trim } else { "unknown" }
    print $"‚úì Hostname: ($hostname)"
    let gen_result = (do { sudo nix-env --list-generations --profile /nix/var/nix/profiles/system } | complete)
    let generation = if $gen_result.exit_code == 0 { $gen_result.stdout | lines | last } else { "unknown" }
    print $"‚úì Current generation: ($generation)"
    let flake_status = if ("flake.lock" | path exists) { "locked" } else { "‚ö†Ô∏è  not locked" }
    print $"‚úì Flake status: ($flake_status)"
    let syntax_result = (do { nix-instantiate --parse configuration.nix } | complete)
    let syntax = if $syntax_result.exit_code == 0 { "valid" } else { "‚ùå invalid" }
    print $"‚úì Configuration syntax: ($syntax)"
    let flake_result = (do { nix flake check --no-build } | complete)
    let flake_check = if $flake_result.exit_code == 0 { "passed" } else { "‚ö†Ô∏è  warnings" }
    print $"‚úì Flake check: ($flake_check)"
    let daemon_result = (do { systemctl is-active nix-daemon.service } | complete)
    let daemon = if $daemon_result.exit_code == 0 { $daemon_result.stdout | str trim } else { "not running" }
    print $"‚úì Nix daemon: ($daemon)"
    let disk_result = (do { du -sh /nix/store } | complete)
    let disk = if $disk_result.exit_code == 0 { $disk_result.stdout | split row "\t" | first } else { "unknown" }
    print $"‚úì Disk usage: ($disk)"
    print ""

# Help target
help:
    @echo "NixOS Multi-Machine Build Targets"
    @echo "================================="
    @echo ""
    @echo "Local builds (default HOST=nixos):"
    @echo "  just switch              # Build and switch to HOST configuration"
    @echo "  just test                # Test HOST configuration"
    @echo "  just boot                # Update boot configuration"
    @echo "  just build               # Build without switching"
    @echo "  just switch HOST=mitosis  # Build mitosis locally"
    @echo ""
    @echo "VM-specific shortcuts:"
    @echo "  just vm-switch           # Build and switch to mitosis"
    @echo "  just vm-test             # Test mitosis configuration"
    @echo ""
    @echo "Remote deployment:"
    @echo "  just remote-switch TARGET_HOST=user@host    # Deploy HOST to remote"
    @echo "  just deploy-vm TARGET_HOST=user@vm-ip       # Deploy VM config"
    @echo "  just remote-test TARGET_HOST=user@host      # Test on remote"
    @echo ""
    @echo "Optional: BUILD_HOST=user@build-server for remote building"
    @echo ""
    @echo "Utilities:"
    @echo "  just hosts               # Show available configurations"
    @echo "  just health              # System health check"
    @echo "  just update              # Update flake inputs"
    @echo "  just check               # Validate flake"
    @echo ""
    @echo "Examples:"
    @echo "  just switch                                  # Local dendrite"
    @echo "  just vm-switch                               # Local VM config"
    @echo "  just deploy-vm TARGET_HOST=admin@192.168.1.100"
    @echo "  just remote-switch HOST=dendrite TARGET_HOST=user@backup-dendrite"
