// Example: How to add gitblade to official claude-hooks
// After running `npx claude-hooks`, add this to your hooks/index.ts

import type { PreToolUsePayload, HookResponse } from "./lib"
import { $ } from "bun"

// Git helpers
async function getGitStatus() {
  try {
    const [status, diff, files] = await Promise.all([
      $`git status --porcelain`.text(),
      $`git diff HEAD`.text().catch(() => ""),
      $`git diff --name-only HEAD`.text()
    ])
    
    return {
      hasChanges: status.trim().length > 0,
      changedFiles: files.trim().split('\n').filter(f => f),
      diffSize: diff.length,
      diff: diff
    }
  } catch {
    return null
  }
}

// Smart diff truncation
function truncateDiff(diff: string, maxLength: number = 8000): string {
  if (diff.length <= maxLength) return diff
  
  const lines = diff.split('\n')
  const summary = []
  let currentFile = ''
  let addedCount = 0
  let removedCount = 0
  
  for (const line of lines) {
    if (line.startsWith('diff --git')) {
      if (currentFile) {
        summary.push(`${currentFile}: +${addedCount} -${removedCount}`)
      }
      currentFile = line.match(/b\/(.*?)$/)?.[1] || ''
      addedCount = 0
      removedCount = 0
    } else if (line.startsWith('+') && !line.startsWith('+++')) {
      addedCount++
    } else if (line.startsWith('-') && !line.startsWith('---')) {
      removedCount++
    }
  }
  
  if (currentFile) {
    summary.push(`${currentFile}: +${addedCount} -${removedCount}`)
  }
  
  return `DIFF SUMMARY (truncated from ${diff.length} chars):
${summary.join('\n')}

[Use 'git diff' to see full changes]`
}

// Add to your PreToolUse handler:
export async function preToolUse(payload: PreToolUsePayload): Promise<HookResponse> {
  if (payload.tool_name !== "Bash") {
    return { action: "continue" }
  }
  
  const command = payload.tool_input.command?.trim() || ""
  
  // Intercept gitblade commands
  if (command.match(/^(gitblade|blade|gb)$/)) {
    console.log("üó°Ô∏è Gitblade activated!")
    
    const gitStatus = await getGitStatus()
    if (!gitStatus || !gitStatus.hasChanges) {
      return {
        action: "skip",
        message: "‚ùå No changes to commit"
      }
    }
    
    const diff = gitStatus.diffSize > 10000 
      ? truncateDiff(gitStatus.diff)
      : gitStatus.diff
    
    // Create the analysis prompt
    const prompt = `üó°Ô∏è GITBLADE COMMIT ASSISTANT

Changed files (${gitStatus.changedFiles.length}):
${gitStatus.changedFiles.join('\n')}

Changes:
${diff}

Create atomic commits for these changes:
1. Group related changes together
2. Use conventional commit format: type(scope): description (max 52 chars)
3. For each commit, show the exact git commands to run

Example output:
git add src/feature.ts src/feature.test.ts
git commit -m "feat(core): add new feature implementation"

git add docs/README.md
git commit -m "docs: update feature documentation"`

    return {
      action: "skip",
      message: prompt
    }
  }
  
  // Suggest gitblade for regular commits
  if (command.startsWith("git commit") && !command.includes("--amend")) {
    return {
      action: "skip", 
      message: "üí° Use 'gitblade' for intelligent commit creation!\n\nJust type: gitblade"
    }
  }
  
  return { action: "continue" }
}